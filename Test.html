#!/usr/bin/env python3
import os
import pandas as pd
import argparse

def process_csv(file_path):
    """
    Processes a single CSV file.
    
    Opens the CSV in read-only mode and checks the "A5" cell (row 5, col 1 in Excel).
    If that cell has a value, the CSV is assumed to be vertical and is transposed.
    Then the function searches for 'xyzzy' and '123123' and checks if the cell to the right is blank.
    
    Returns a list of result strings (one per finding).
    """
    results = []
    try:
        # Read CSV without assuming any header
        df = pd.read_csv(file_path, header=None, dtype=str)
    except Exception as e:
        print(f"Error reading {file_path}: {e}")
        return results

    # Determine if CSV is stored vertically by checking the 5th row, first column (A5)
    if df.shape[0] >= 5:
        cell_value = df.iloc[4, 0]
        if pd.notna(cell_value) and str(cell_value).strip() != "":
            # If the cell is not empty, assume vertical orientation; transpose to horizontal
            df = df.transpose()

    # Define the search values
    search_values = {"xyzzy", "123123"}

    # Loop through each cell in the DataFrame
    for i in range(df.shape[0]):
        for j in range(df.shape[1]):
            cell = df.iloc[i, j]
            if str(cell).strip() in search_values:
                # Check the next cell to the right in the same row if it exists
                next_val = None
                if j + 1 < df.shape[1]:
                    next_val = df.iloc[i, j+1]
                # Determine if the next cell is blank (empty or NaN)
                if next_val is None or pd.isna(next_val) or str(next_val).strip() == "":
                    # Prepare a tab-delimited output line
                    line = f"{os.path.basename(file_path)}\t{file_path}\t{cell}\t{next_val}"
                    results.append(line)
    return results

def main():
    # Setup command-line argument parsing
    parser = argparse.ArgumentParser(
        description="Search CSV files for specific values and check for blank next cells."
    )
    parser.add_argument(
        "--search-dir", type=str, required=True,
        help="Directory to search for CSV files (including subdirectories)."
    )
    parser.add_argument(
        "--output", type=str, required=True,
        help="File path for the output TXT file."
    )
    args = parser.parse_args()

    all_results = []

    # Walk through the directory and its subdirectories to find CSV files
    for root, _, files in os.walk(args.search_dir):
        for file in files:
            if file.lower().endswith(".csv"):
                file_path = os.path.join(root, file)
                results = process_csv(file_path)
                if results:
                    all_results.extend(results)

    # Write the findings to the designated output text file
    try:
        with open(args.output, "w") as out_file:
            for line in all_results:
                out_file.write(line + "\n")
        print(f"Results exported to: {args.output}")
    except Exception as e:
        print(f"Error writing output file: {e}")

if __name__ == "__main__":
    main()
