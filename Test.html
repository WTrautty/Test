import openpyxl
import numpy as np
import warnings
import os
from datetime import datetime
import re
import traceback

# --- Configuration ---
EXCEL_FILE = r"C:\Path\To\Inventory.xlsx"
LASER_FILE = r"C:\Path\To\LASER Export.xlsx"

# Output directory base
OUTPUT_BASE = r"C:\Path\To\Output"

# --- Suppress openpyxl warnings ---
warnings.simplefilter("ignore", category=UserWarning)

# --- Region maps ---
def identify_region(wan_ipv6):
    try:
        return wan_ipv6.split(":")[2][1]
    except IndexError:
        return None

def lan_subnet_fix(lan_ipv6):
    try:
        address, subnet = lan_ipv6.split("/")
        hex_groups = address.split(":")
        if len(hex_groups[3]) == 3:
            hex_groups[3] = "0" + hex_groups[3]
        return ":".join(hex_groups) + "/56"
    except Exception:
        return None

def ce_wan_address(ipv6):
    try:
        addr, subnet = ipv6.split("/")
        parts = addr.split(":")
        parts[-1] = format(int(parts[-1], 16) + 1, "x")
        return ":".join(parts) + "/" + subnet
    except:
        return None

def ipv6_region_map(region): return {"1": "East", "2": "North", "3": "Central", "4": "West", "5": "Alaska"}.get(region, "unknown")
def md_pw_map(region): return {"1": "5CB...", "2": "17A...", "3": "A78...", "4": "38C...", "5": "D41..."}.get(region, "unknown")
def juniper_RI_map(region): return {"1": "8192-...", "2": "8193-...", "3": "8194-...", "4": "8195-...", "5": "UNKNOWN"}.get(region, "unknown")
def Nokia_vprn_map(region): return {"1": "22826008", "2": "22826009", "3": "22826010", "4": "22826011", "5": "UNKNOWN"}.get(region, "unknown")

def find_header_row(sheet):
    data = np.array([row for row in sheet.iter_rows(min_row=1, max_row=20, values_only=True)], dtype=object)
    for i, row in enumerate(data, start=1):
        if np.count_nonzero(row) > 2:
            return list(row), i
    return None, None

def search_laser(service_id, laser_wb, region):
    sheet = laser_wb["Sheet1"]
    header, idx = find_header_row(sheet)
    headers = {h: i for i, h in enumerate(header)}
    results = []

    for row in sheet.iter_rows(min_row=idx+1, values_only=True):
        for key in headers:
            if "circuitID" in key.lower():
                if service_id.lower() in str(row[headers[key]]).lower():
                    data = {k: row[i] for k, i in headers.items()}
                    results.append(data)
    suffix = f"80{region}"
    for r in results:
        if str(r.get("interface", "")).strip().endswith(suffix):
            return r
    return {}

# --- Main ---
try:
    order_input = input("Enter the order number (Ops Console Ticket): ").strip()

    wb_main = openpyxl.load_workbook(EXCEL_FILE, read_only=True)
    sheet = wb_main["Main"]
    header, header_idx = find_header_row(sheet)
    headers = {h: i for i, h in enumerate(header)}

    order_data = None
    for row in sheet.iter_rows(min_row=header_idx + 1, values_only=True):
        if str(row[headers["Ops Console Ticket"]]).strip() == order_input:
            order_data = {k: row[i] for k, i in headers.items()}
            break

    if not order_data:
        print("Order not found.")
        exit()

    region = identify_region(order_data.get("IPv6 WAN", ""))
    lan_fixed = lan_subnet_fix(order_data.get("IPv6 LAN", ""))
    ce_wan = ce_wan_address(order_data.get("IPv6 WAN", ""))
    area = ipv6_region_map(region)
    md_pw = md_pw_map(region)
    jri = juniper_RI_map(region)
    vprn = Nokia_vprn_map(region)

    # Laser match
    wb_laser = openpyxl.load_workbook(LASER_FILE, read_only=True)
    laser_match = search_laser(order_data.get("Service ID", ""), wb_laser, region)

    # Template selection
    device = laser_match.get("device", "")
    interface = laser_match.get("interface", "")
    vendor = order_data.get("Vendor", "")
    pe_type = "Alcatel" if device.upper().startswith("ESP") else "Juniper"
    template_path = r"C:\Path\To\Template.txt"

    with open(template_path, "r", encoding="utf-8") as f:
        template = f.read()

    # Replace placeholders
    template = template.replace('{Ops Console Ticket}', order_input)
    template = template.replace('{Region}', region or "")
    template = template.replace('{Lan (Data 1)}', lan_fixed or "")
    template = template.replace('{WAN/126 CE}', ce_wan or "")
    template = template.replace('{WAN/126 CEnoSub}', (ce_wan.split('/')[0] if ce_wan else ""))
    template = template.replace('{md_pw}', md_pw or "")
    template = template.replace('{jRI}', jri or "")
    template = template.replace('{vprn}', vprn or "")
    template = template.replace('{area}', area or "")
    template = template.replace('{pe_type}', pe_type)
    template = template.replace('{Service ID}', order_data.get("Service ID", ""))
    template = template.replace('{IPv6 WAN}', order_data.get("IPv6 WAN", ""))
    template = template.replace('{IPv6 LAN}', order_data.get("IPv6 LAN", ""))
    template = template.replace('{Vendor}', vendor or "")
    template = template.replace('{default_interface}', interface)
    template = template.replace('{default_device}', device)
    template = template.replace('{default_scid}', laser_match.get("scid", ""))
    template = template.replace('{default_location}', laser_match.get("location", ""))
    template = template.replace('{default_wan_ip}', laser_match.get("ipv4", ""))
    template = template.replace('{default_vrf}', laser_match.get("vrf", ""))

    # Output path
    today = datetime.now().strftime("%Y-%m-%d")
    output_dir = os.path.join(OUTPUT_BASE, today)
    os.makedirs(output_dir, exist_ok=True)
    file_path = os.path.join(output_dir, f"{order_input} - {today} - Pre-Checks.txt")

    with open(file_path, 'w', encoding='utf-8') as f:
        f.write(template)
    print(f"Output written to: {file_path}")

except Exception as e:
    print(f"Failed with error: {e}")
    traceback.print_exc()
