import re

def mb_to_kbps(mb_str):
    return str(int(mb_str.lower().replace("mb", "")) * 1000)

# Read bandwidths from file
with open("bandwidths.txt", "r") as bw_file:
    bandwidths = [mb_to_kbps(line.strip()) for line in bw_file if line.strip()]

# Read the config file
with open("config.txt", "r") as config_file:
    config_lines = config_file.readlines()

# Split config into chunks using 'vprn' as the delimiter
chunks = []
current_chunk = []
for line in config_lines:
    if "vprn" in line:
        if current_chunk:
            chunks.append(current_chunk)
            current_chunk = []
    current_chunk.append(line)
if current_chunk:
    chunks.append(current_chunk)

# Replace rates in each chunk
updated_chunks = []
for i, chunk in enumerate(chunks):
    if i >= len(bandwidths):
        print(f"⚠️ Not enough bandwidth entries for all chunks. Skipping chunk {i}.")
        break
    bw_kbps = bandwidths[i]
    new_chunk = []
    for line in chunk:
        # Replace rate and cir values
        line = re.sub(r"(rate\s+)\d+", r"\1" + bw_kbps, line)
        line = re.sub(r"(cir\s+)\d+", r"\1" + bw_kbps, line)
        new_chunk.append(line)
    updated_chunks.append(new_chunk)

# Flatten and write the updated config to a new file
with open("updated_config.txt", "w") as out_file:
    for chunk in updated_chunks:
        out_file.writelines(chunk)

print("✅ Configuration updated and written to 'updated_config.txt'.")
