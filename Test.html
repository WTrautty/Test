import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.cm import get_cmap
import matplotlib.patches as mpatches

# === CONFIGURATION ===
file_path = r"C:\Users\Checker.xlsx"
sheet_name = "Sheet2"

misc_threshold_failures = 5
misc_threshold_usage = 20
misc_threshold_rate = 15
label_threshold_pct = 3

# === LOAD DATA ===
df = pd.read_excel(file_path, sheet_name=sheet_name, engine="openpyxl")
failures_raw = df.iloc[:, 0].dropna().astype(str).str.strip()  # Failures
usages_raw = df.iloc[:, 1].dropna().astype(str).str.strip()    # Usages

failures = failures_raw.value_counts()
usages = usages_raw.value_counts()

# === BUILD CONSISTENT COLOR MAP ===
all_lecs = sorted(set(failures.index).union(set(usages.index)))
cmap = get_cmap('nipy_spectral', len(all_lecs) + 1)

lec_color_map = {lec: cmap(i) for i, lec in enumerate(all_lecs)}
lec_color_map["Misc."] = '#888888'

# === PIE CHART FUNCTION ===
def plot_pie_chart(data, title, misc_threshold):
    frequent = data[data > misc_threshold]
    misc_count = data[data <= misc_threshold].sum()
    chart_data = frequent.copy()
    chart_data["Misc."] = misc_count
    total = chart_data.sum()
    percentages = (chart_data / total) * 100

    labels = []
    legend_labels = []
    legend_colors = []
    
    for label, pct in percentages.items():
        count = chart_data[label]
        color = lec_color_map.get(label, '#CCCCCC')
        if pct >= label_threshold_pct:
            labels.append(f"{label}\n{count} ({round(pct)}%)")
        else:
            labels.append("")
            legend_labels.append(f"{label} - {count} ({round(pct)}%)")
            legend_colors.append(color)

    colors = [lec_color_map.get(label, '#CCCCCC') for label in chart_data.index]

    fig, ax = plt.subplots(figsize=(10, 8))
    wedges, texts = ax.pie(
        chart_data,
        labels=labels,
        startangle=140,
        colors=colors,
        wedgeprops=dict(edgecolor='white'),
        labeldistance=1.2
    )

    for text in texts:
        text.set_horizontalalignment('center')
        text.set_fontsize(9)

    if legend_labels:
        legend_patches = [mpatches.Patch(color=legend_colors[i], label=legend_labels[i]) for i in range(len(legend_labels))]
        ax.legend(handles=legend_patches, title="Other (<3%)", loc="center left", bbox_to_anchor=(1.15, 0.5))

    plt.title(title)
    plt.tight_layout()
    plt.show()

# === PLOT PIE CHARTS ===
plot_pie_chart(failures, "LEC Failures", misc_threshold_failures)
plot_pie_chart(usages, "LEC Usage", misc_threshold_usage)

# === FAILURE RATE BAR CHART ===
frequent_failures = failures[failures > misc_threshold_rate]
misc_failures_count = failures[failures <= misc_threshold_rate].sum()

failure_counts = frequent_failures.copy()
failure_counts["Misc."] = misc_failures_count

frequent_lecs = set(frequent_failures.index)
usage_counts = pd.Series(dtype=int)

for lec, count in usages.items():
    if lec in frequent_lecs:
        usage_counts[lec] = count
    else:
        usage_counts["Misc."] = usage_counts.get("Misc.", 0) + count

failure_rate = {}
for lec in failure_counts.index:
    fail = failure_counts[lec]
    use = usage_counts.get(lec, 0)
    if use > 0:
        failure_rate[lec] = (fail / use) * 100
    else:
        failure_rate[lec] = 0

rate_df = pd.Series(failure_rate).sort_values(ascending=False)

# === PLOT FAILURE RATE BAR CHART ===
if not rate_df.empty:
    colors = [lec_color_map.get(label, '#CCCCCC') for label in rate_df.index]
    plt.figure(figsize=(12, 8))
    rate_df.plot(kind='barh', color=colors)
    plt.xlabel("Failure Rate (%)")
    plt.title("LEC Failure Rate (Grouped with 'Misc.')")
    plt.gca().invert_yaxis()
    plt.grid(axis='x', linestyle='--', alpha=0.5)
    plt.tight_layout()
    plt.show()
else:
    print("\n⚠️ No failure rates to plot.")
