import os
import csv

# ----- CONFIGURATION VARIABLES -----
# Set the directory to search for CSV files
search_directory = "/path/to/search/directory"  # CHANGE THIS

# Set the path (and filename) for the exported TXT file
output_txt_path = "/path/to/output/results.txt"  # CHANGE THIS

# ----- HELPER FUNCTION -----
def read_csv_with_fallback(file_path):
    """
    Tries to open the CSV file with utf-8 encoding first, then latin1 if utf-8 fails.
    Returns the CSV data as a list of rows.
    """
    try:
        with open(file_path, mode='r', encoding='utf-8', newline='') as f:
            reader = csv.reader(f)
            data = list(reader)
    except UnicodeDecodeError:
        with open(file_path, mode='r', encoding='latin1', newline='') as f:
            reader = csv.reader(f)
            data = list(reader)
    return data

def transpose_data(data):
    """
    Transposes a list of lists (data from CSV). Note that zip truncates to the shortest row.
    """
    # Using * to unpack rows and then mapping to list for each transposed row
    return list(map(list, zip(*data)))

# ----- MAIN PROCESSING -----
results = []  # List to hold result lines

for root, dirs, files in os.walk(search_directory):
    for file in files:
        if file.lower().endswith('.csv'):
            csv_file_path = os.path.join(root, file)
            # Read the CSV with encoding fallback
            data = read_csv_with_fallback(csv_file_path)
            
            # If the CSV has at least 5 rows, check the 5th row (index 4) and first column
            if len(data) >= 5 and len(data[4]) > 0:
                # Check if the cell equivalent to A5 (first column in 5th row) has a value
                if data[4][0].strip() != '':
                    # Transpose the CSV in memory (this does not change the file)
                    data = transpose_data(data)
            
            # Now scan the (horizontal) data for the search pattern.
            # We iterate over each row and check for cells starting with "xyzzy" and ending with "123123".
            for row in data:
                # Loop through cells, but stop at the second-to-last cell (so we can check the next cell)
                for i in range(len(row) - 1):
                    cell = row[i].strip()
                    if cell.startswith("xyzzy") and cell.endswith("123123"):
                        next_cell = row[i + 1].strip()  # The cell immediately after the matched cell
                        # Check if the next cell is blank
                        if next_cell == '':
                            # Prepare a result line: file name, full path, the found cell value, and the next cell value
                            results.append(f"{file}\t{csv_file_path}\t{cell}\t{next_cell}")

# ----- EXPORT RESULTS -----
# Write the collected results to the output TXT file.
with open(output_txt_path, "w", encoding="utf-8") as out_f:
    for line in results:
        out_f.write(line + "\n")

print(f"Results exported to {output_txt_path}")
