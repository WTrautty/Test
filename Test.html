import paramiko
import getpass

# === Configuration ===
BASTION = input("Enter bastion IP or hostname: ").strip()
USER = input("Enter SSH username: ").strip()
PASSWORD = getpass.getpass("Enter MFA password: ").strip()
OUTPUT_FILE = r"C:\Users\AD39644\Downloads\ssh_output.txt"  # <-- Change this if needed

# === Commands to Run ===
COMMANDS = [
    "whoami",
    "hostname",
    "uptime",
    # Add more commands here
]

def ssh_and_run_commands(host, username, password, commands, output_path):
    print(f"\n🔐 Connecting to {host} as {username}...")

    client = paramiko.SSHClient()
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

    try:
        client.connect(hostname=host, username=username, password=password)
        print("✅ Connection established.\n")

        with open(output_path, "a", encoding="utf-8") as f:
            f.write(f"\n--- SSH Session to {host} as {username} ---\n\n")

            for cmd in commands:
                f.write(f"$ {cmd}\n")
                stdin, stdout, stderr = client.exec_command(cmd)
                out = stdout.read().decode()
                err = stderr.read().decode()

                if out:
                    f.write(out)
                if err:
                    f.write("\n[stderr]\n" + err)

                f.write("\n" + "-" * 40 + "\n")

        print(f"📄 Output appended to: {output_path}")

    except Exception as e:
        print(f"❌ SSH connection or command error: {e}")
    finally:
        client.close()
        print("🔒 SSH session closed.")

# === Run it
ssh_and_run_commands(BASTION, USER, PASSWORD, COMMANDS, OUTPUT_FILE)
