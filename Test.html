
# Get current date string for file naming
from datetime import datetime
current_date = datetime.now().strftime("%Y-%m-%d")
output_directory = r"C:\Users\AD39644"

# Process each order
for order in all_orders:
    try:
        data = order["Data"]
        # Get order number from "Ops Console Ticket" (adjust the key if necessary)
        order_number = str(data.get("Ops Console Ticket", "")).strip()
        if not order_number:
            continue  # Skip if no order number is found

        service_id = str(data.get("Service ID", "")).strip()
        ipv6_region = identify_region(data.get("IPv6 WAN", ""))
        fixed_lan = lan_subnet_fix(data.get("IPv6 LAN", ""))
        ce_wan = ce_wan_address(data.get("IPv6 WAN", ""))
        area = ipv6_region_map(ipv6_region)
        md_pw = md_pw_map(ipv6_region)
        jRI = juniper_RI_map(ipv6_region)
        vprn = Nokia_vprn_map(ipv6_region)
        j_bar = j_barton(data.get("IPv6 LAN", ""))

        # Search LASER file for this order's Service ID
        laser_matches = search_circuit(service_id)

        # Get default interface details from laser matches
        default_interface, default_device, default_scid, default_location = get_default_interface(laser_matches, ipv6_region)

        # Choose a template based on the device type; for example, if default_device starts with "ESP" use one template.
        if default_device.upper().startswith("ESP"):
            template_path = r"C:\Users\AD39644\Service Information ESP.txt"
        else:
            template_path = r"C:\Users\AD39644\Service Information Juno.txt"

        with open(template_path, 'r') as file:
            template = file.read()

        # Replace placeholders from the main file
        template = template.replace('{Ops Console Ticket}', order_number)
        template = template.replace('{Region}', ipv6_region)
        template = template.replace('{Lan (Data 1)}', fixed_lan if fixed_lan else "")
        template = template.replace('{WAN/126 CE}', ce_wan if ce_wan else "")
        template = template.replace('{WAN/126 CEnoSub}', ce_wan.split('/')[0] if ce_wan else "")
        template = template.replace('{md_pw}', md_pw)
        template = template.replace('{j_bar}', j_bar if j_bar else "")
        template = template.replace('{jRI}', jRI)
        template = template.replace('{vprn}', vprn)
        template = template.replace('{area}', area)
        template = template.replace('{IPv6_wan_noSub}', data.get("IPv6 WAN", "").split('/')[0])
        template = template.replace('{IPv6_lan_noSub}', data.get("IPv6 LAN", "").split('/')[0])
        template = template.replace('{IPv6_lan_noSuband1}', data.get("IPv6 LAN", "").split('/')[0] + "1")
        template = template.replace('{IPv6_lan_Sub64and1}', data.get("IPv6 LAN", "").split('/')[0] + "1/64")
        template = template.replace('{WAN_CE}', data.get("IPv6 WAN", "").split('/')[0])
        template = template.replace('{Node_Only}', data.get("Node Name", "").split('.')[0])
        template = template.replace('{regional_vlan}', "80" + ipv6_region)
        template = template.replace('{IPv6 Status}', data.get("IPv6 Status", ""))
        if data.get("IPv6 Loopback", ""):
            loopback_parts = data.get("IPv6 Loopback", "").split('/')
            if len(loopback_parts) > 1:
                template = template.replace('{IPv6 Loopback_andone}', loopback_parts[0] + "/" + loopback_parts[1])
        template = template.replace('{Service ID}', data.get("Service ID", ""))
        template = template.replace('{IPv6 WAN}', data.get("IPv6 WAN", ""))
        template = template.replace('{IPv6 LAN}', data.get("IPv6 LAN", ""))
        template = template.replace('{IPv6 Loopback}', data.get("IPv6 Loopback", ""))
        template = template.replace('{DOI_Bureau}', data.get("DOI_Bureau", ""))
        template = template.replace('{WHD_Location}', data.get("WHD_Location", ""))
        template = template.replace('{Node Name}', data.get("Node Name", ""))
        template = template.replace('{IP Address}', data.get("IP Address", ""))
        template = template.replace('{Address}', data.get("Address", ""))
        template = template.replace('{City}', data.get("City", ""))
        template = template.replace('{State}', data.get("State", ""))
        template = template.replace('{Vendor}', data.get("Vendor", ""))

        # Replace new placeholders from LASER results
        template = template.replace('{default_interface}', default_interface)
        template = template.replace('{default_device}', default_device)
        template = template.replace('{default_scid}', default_scid)
        template = template.replace('{default_location}', default_location)
        if default_interface:
            template = template.replace('{def_int_noSub}', default_interface.split('.')[0])
        else:
            template = template.replace('{def_int_noSub}', "")

        # Append network match details from LASER search
        network_info = "\n\nNetwork Matches:\n\n"
        for lm in laser_matches:
            lm_data = lm["Data"]
            for key, value in lm_data.items():
                network_info += f"{key}: {value}\n"
            network_info += "\n-----------------\n\n"
        template += network_info

        # Create the output filename and path
        output_filename = f"{order_number} - {current_date} - Pre-Checks.txt"
        output_path = os.path.join(output_directory, output_filename)

        # Write the final text file
        with open(output_path, 'w') as file:
            file.write(template)
        print(f"New text file '{output_path}' created successfully!")
    except Exception as e:
        # If an error occurs, write the error message to the output file for this order
        error_text = f"Error processing order {order_number}: {str(e)}"
        output_filename = f"{order_number} - {current_date} - Pre-Checks.txt"
        output_path = os.path.join(output_directory, output_filename)
        with open(output_path, 'w') as file:
            file.write(error_text)
        print(f"Issue with order {order_number}: {error_text}")
