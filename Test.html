# $language = "python"
# $interface = "1.0"

import os
import time

def wait_for_any(prompts, total_timeout):
    """
    Waits until one of the prompts in the list appears on the screen,
    or until total_timeout seconds have elapsed.
    
    Args:
        prompts: A list of strings to wait for.
        total_timeout: Maximum time (in seconds) to wait.
        
    Returns:
        The prompt string that was detected, or None if no prompt was found.
    """
    start_time = time.time()
    while (time.time() - start_time) < total_timeout:
        for prompt in prompts:
            # A zero-second timeout does an immediate check
            if crt.Screen.WaitForString(prompt, 0):
                return prompt
        time.sleep(0.1)
    return None

def main():
    # Prompt the user for the full path to the command file.
    command_file = crt.Dialog.Prompt("Enter full path to command file:", "Command File", "", False)
    if not command_file:
        crt.Dialog.MessageBox("No file specified. Exiting.")
        return

    if not os.path.isfile(command_file):
        crt.Dialog.MessageBox("File not found: " + command_file)
        return

    try:
        file_handle = open(command_file, "r")
        content = file_handle.read()
        file_handle.close()
    except Exception as e:
        crt.Dialog.MessageBox("Error reading file: " + str(e))
        return

    # Split the file contents into commands using the delimiter "&new&".
    commands = [cmd.strip() for cmd in content.split("&new&") if cmd.strip()]

    # Prompt for timeout (seconds)
    timeout_str = crt.Dialog.Prompt("Enter timeout in seconds (default 10):", "Timeout", "10", False)
    try:
        timeout = int(timeout_str)
    except:
        timeout = 10

    # Define the two prompt strings we want to detect (you can adjust these as needed)
    prompts_to_wait_for = ["(", "@"]
    
    for cmd in commands:
        crt.Session.SetStatusText("Executing command: " + cmd)
        crt.Screen.Send(cmd + "\r")
        detected = wait_for_any(prompts_to_wait_for, timeout)
        if detected:
            crt.Session.SetStatusText("Detected prompt: " + detected + " -- continuing")
        else:
            crt.Dialog.MessageBox("Timeout waiting for prompt after command: " + cmd)
            # Optionally, you could break here if a prompt is not detected.
            # break

main()
