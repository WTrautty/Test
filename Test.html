from openpyxl.utils import get_column_letter
from collections import defaultdict

# === Build schedule map by technician ===
schedule_map = defaultdict(list)  # {tech_name: [(start_time, end_time, subject)]}

for i, appt in enumerate(appointments):
    schedule_map[best[i]].append((appt["start"], appt["end"], appt["subject"]))

# === Create the "Schedule View" sheet ===
if "Schedule View" in wb.sheetnames:
    del wb["Schedule View"]
ws_sched = wb.create_sheet("Schedule View")

# Time slots to visualize (30-min increments from earliest to latest appointment)
all_times = [appt["start"] for appt in appointments] + [appt["end"] for appt in appointments]
min_time = min(all_times).replace(minute=0)
max_time = max(all_times)
time_slots = []
cur = min_time
while cur <= max_time:
    time_slots.append(cur)
    cur += timedelta(minutes=30)

# Technician columns
tech_names = [t["name"] for t in technicians]
ws_sched.append(["Time"] + tech_names)

# Create a lookup for start time row numbers
time_row_map = {slot.strftime("%H:%M"): idx + 2 for idx, slot in enumerate(time_slots)}

# Fill time labels in column A
for idx, slot in enumerate(time_slots):
    ws_sched.cell(row=idx + 2, column=1).value = slot.strftime("%H:%M")

# Track used cells to avoid overlaps
used_cells = defaultdict(set)  # {tech_name: set(row_nums)}

# Fill and merge cells per appointment
for col_idx, tech in enumerate(tech_names, start=2):
    for start, end, subject in schedule_map[tech]:
        start_str = start.strftime("%H:%M")
        end_str = end.strftime("%H:%M")

        start_row = time_row_map.get(start_str)
        end_row = time_row_map.get(end_str, len(time_slots) + 2)

        if start_row is None or end_row is None:
            continue

        # Only write if we haven't already used this block
        if any(r in used_cells[tech] for r in range(start_row, end_row)):
            continue

        cell = ws_sched.cell(row=start_row, column=col_idx)
        cell.value = subject

        if end_row - start_row > 1:
            ws_sched.merge_cells(
                start_row=start_row, start_column=col_idx,
                end_row=end_row - 1, end_column=col_idx
            )

        for r in range(start_row, end_row):
            used_cells[tech].add(r)
