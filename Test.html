import openpyxl
import random
import math
from datetime import datetime, timedelta

# === Load Excel Workbook ===
wb = openpyxl.load_workbook("Outlook_Calendars.xlsx")
appointments = []
technicians = []

# === Load Technicians ===
ws_tech = wb["Technicians"]
for row in ws_tech.iter_rows(min_row=2, values_only=True):
    technicians.append({
        "name": row[0],
        "start": datetime.strptime(row[1], "%H:%M").time(),
        "end": datetime.strptime(row[2], "%H:%M").time(),
        "max": row[3],
    })

# === Load Appointments from First Mailbox Sheet ===
mailbox_sheet = [ws for ws in wb.sheetnames if ws not in ["Technicians", "Optimized Schedule"]][0]
ws_appt = wb[mailbox_sheet]
for row in ws_appt.iter_rows(min_row=2, values_only=True):
    try:
        start_time = row[1]
        end_time = row[2]
        appointments.append({
            "subject": row[0],
            "start": start_time,
            "end": end_time,
            "duration": (end_time - start_time).total_seconds() / 60,
            "location": row[3],
        })
    except Exception:
        continue

# === Simulated Annealing ===
def cost(schedule):
    penalty = 0
    tech_counts = {t["name"]: 0 for t in technicians}

    for i, appt in enumerate(appointments):
        tech = schedule[i]
        tech_info = next(t for t in technicians if t["name"] == tech)
        tech_counts[tech] += 1

        if tech_counts[tech] > tech_info["max"]:
            penalty += 100  # Overbooked

        if not (tech_info["start"] <= appt["start"].time() <= tech_info["end"]):
            penalty += 50  # Outside working hours

    return penalty

# === Initialize Random Assignment ===
current = [random.choice(technicians)["name"] for _ in appointments]
best = list(current)
best_cost = cost(best)

T = 1000.0
T_min = 1.0
alpha = 0.95

while T > T_min:
    i = random.randint(0, len(appointments)-1)
    new = list(current)
    new[i] = random.choice(technicians)["name"]

    curr_cost = cost(current)
    new_cost = cost(new)

    if new_cost < curr_cost or math.exp((curr_cost - new_cost) / T) > random.random():
        current = new
        if new_cost < best_cost:
            best = new
            best_cost = new_cost

    T *= alpha

# === Write Results to New Sheet ===
if "Optimized Schedule" in wb.sheetnames:
    del wb["Optimized Schedule"]
ws_out = wb.create_sheet("Optimized Schedule")
ws_out.append(["Subject", "Start", "End", "Location", "Assigned Technician"])

for i, appt in enumerate(appointments):
    ws_out.append([
        appt["subject"],
        appt["start"],
        appt["end"],
        appt["location"],
        best[i],
    ])

wb.save("Outlook_Calendars.xlsx")
print(f"\nâœ… Optimized schedule written to 'Optimized Schedule' tab in Excel.")
