import win32com.client
from datetime import datetime, timedelta
import openpyxl
from openpyxl import Workbook

# === Settings ===
EXPORT_FILE = "Outlook_Calendars.xlsx"
DAYS_FORWARD = 30

# Initialize Excel workbook
wb = Workbook()
wb.remove(wb.active)  # remove default sheet

# Connect to Outlook
outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")
now = datetime.now()
future = now + timedelta(days=DAYS_FORWARD)

# Loop through all top-level mailboxes
for i in range(outlook.Folders.Count):
    try:
        mailbox = outlook.Folders.Item(i + 1)
        calendar = mailbox.Folders("Calendar")
        
        # Prepare calendar items
        items = calendar.Items
        items.Sort("[Start]")
        items.IncludeRecurrences = True

        restriction = "[Start] >= '{}' AND [Start] <= '{}'".format(
            now.strftime('%m/%d/%Y %H:%M %p'),
            future.strftime('%m/%d/%Y %H:%M %p')
        )
        restricted_items = items.Restrict(restriction)

        # Create a new sheet for this mailbox calendar
        sheet_name = mailbox.Name[:31]  # Excel sheet name limit
        ws = wb.create_sheet(title=sheet_name)
        ws.append(["Subject", "Start", "End", "Location"])

        for item in restricted_items:
            try:
                ws.append([item.Subject, item.Start, item.End, item.Location])
            except Exception as e:
                ws.append(["Error reading item", "", "", str(e)])
        
        print(f"Exported: {mailbox.Name}")
    
    except Exception as e:
        print(f"Skipping mailbox {i+1}: {e}")

# Save to Excel
wb.save(EXPORT_FILE)
print(f"\nâœ… Export complete: {EXPORT_FILE}")
