
#!/usr/bin/env python3
import paramiko
import sys
import getpass

def run_commands_on_bastion(hostname, username, commands):
    """
    Connect to bastion host and execute commands using MFA code as password
    """
    ssh = None
    try:
        # Initialize SSH client
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        
        # Get the current MFA code
        mfa_code = input('Enter MFA code: ').strip()
        
        # Connect using the MFA code as password
        print("Attempting to connect to bastion...")
        ssh.connect(hostname, username=username, password=mfa_code)
        print("Successfully connected to bastion")
        
        # Execute each command and collect results
        results = []
        for cmd in commands:
            print(f"\nExecuting command: {cmd}")
            stdin, stdout, stderr = ssh.exec_command(cmd)
            
            # Get command output
            output = stdout.read().decode().strip()
            

            if output:
                print(f"Output: {output}")
                
        results.append({
            'command': cmd,
            'output': output,
            **({'error': error} if 'error' in locals() else {})
        })
            
        return results
            
    except paramiko.AuthenticationException:
        print("Authentication failed. Please check your MFA code.")
        return None
    except paramiko.SSHException as ssh_error:
        print(f"SSH error occurred: {str(ssh_error)}")
        return None
    except Exception as e:
        print(f"Connection failed: {str(e)}")
        return None
    finally:
        if ssh:
            ssh.close()

def main():
    # Prompt for connection details
    hostname = input("Enter bastion hostname: ").strip()
    username = input("Enter username: ").strip()
    
    # List of commands to execute - examples with different types of quotes
    commands = [
        '~jbarton/fa.sh 2001:49c8:1470:1300::[0-3]',
        'roci --vcmd "Alcatel/show router 22826010 route-table 2001:49c8:1320:040f::1/126" esp1.slc1',
        'roci --vcmd "Alcatel/show router 22826010 route-table 2001:49c8:1320:0400::/64" esp1.slc1',
        'roci --vcmd "Alcatel/show router 22826010 route-table 2001:49c8:1320:040e::1/128" esp1.slc1', # Simple double quotes
        
    ]
    results = run_commands_on_bastion(hostname, username, commands)
    
if __name__ == "__main__":
    main()
