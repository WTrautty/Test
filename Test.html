import pandas as pd
import matplotlib.pyplot as plt

# Load Excel
file_path = r"C:\Users\AD39644\On\lsx"
df = pd.read_excel(file_path, sheet_name='Sheet2', engine='openpyxl')

# === Extract and clean both columns ===
failures_raw = df.iloc[:, 12].dropna().astype(str).str.strip()
usages_raw = df.iloc[:, 2].dropna().astype(str).str.strip()

# === Count LEC occurrences ===
failures = failures_raw.value_counts()
usages = usages_raw.value_counts()

# === Group infrequent LECs (failures <= 15) into "Misc." ===
frequent_failures = failures[failures > 15]
misc_failures_count = failures[failures <= 15].sum()

# Combine with "Misc."
failure_counts = frequent_failures.copy()
failure_counts["Misc."] = misc_failures_count

# Adjust usage counts to align with "Misc." grouping
# Build a full LEC list for failure/usage combo
all_lecs = set(failure_counts.index).union(set(usages.index))

# Group usage data to match Misc. grouping
frequent_lecs = set(frequent_failures.index)
usage_counts = pd.Series(dtype=int)

for lec in usages.index:
    count = usages[lec]
    if lec in frequent_lecs:
        usage_counts[lec] = count
    else:
        usage_counts["Misc."] = usage_counts.get("Misc.", 0) + count

# === Calculate failure rates ===
failure_rate = {}
for lec in failure_counts.index:
    fail = failure_counts[lec]
    use = usage_counts.get(lec, 0)
    if use > 0:
        failure_rate[lec] = (fail / use) * 100
    else:
        failure_rate[lec] = 0

# === Convert to DataFrame and sort ===
rate_df = pd.Series(failure_rate).sort_values(ascending=False)

# === Plot horizontal bar chart ===
plt.figure(figsize=(12, 8))
rate_df.plot(kind='barh', color='#E15759')
plt.xlabel("Failure Rate (%)")
plt.title("LEC Failure Rate (Grouped with 'Misc.')")
plt.gca().invert_yaxis()
plt.grid(axis='x', linestyle='--', alpha=0.5)
plt.tight_layout()
plt.show()
