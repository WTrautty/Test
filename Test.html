import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.cm as cm

# Load the Excel file
file_path = r"C:\Users\Checker.xlsx"  # <-- change this to your file
df = pd.read_excel(file_path, sheet_name='Sheet2', engine='openpyxl')

# === Extract Column L (LEC Name) ===
lec_names = df.iloc[:, 0]
lec_counts = lec_names.value_counts()

# === Group infrequent entries into "Misc." ===
frequent = lec_counts[lec_counts > 5]
misc_count = lec_counts[lec_counts <= 5].sum()
chart_data = frequent.copy()
chart_data["Misc."] = misc_count

# === Move "Misc." to the end ===
if "Misc." in chart_data:
    misc_value = chart_data.pop("Misc.")
    chart_data["Misc."] = misc_value

# === Calculate percentages ===
total = chart_data.sum()
percentages = (chart_data / total) * 100

# === Determine label logic ===
labels = []
legend_labels = []
for label, pct in percentages.items():
    if pct >= 3:
        labels.append(f"{label} ({pct:.1f}%)")  # Label shown on slice
    else:
        labels.append("")  # No label on slice
        legend_labels.append(f"{label} ({pct:.1f}%)")  # Goes in legend

# === Assign Custom Colors (one for each slice) ===
base_colors = [
    '#4E79A7', '#F28E2B', '#E15759', '#76B7B2',
    '#59A14F', '#EDC948', '#B07AA1', '#FF9DA7',
    '#9C755F', '#BAB0AC', '#888888'
]
# Extend if needed
color_list = (base_colors * ((len(chart_data) // len(base_colors)) + 1))[:len(chart_data)]

# === Plot Pie Chart ===
fig, ax = plt.subplots(figsize=(10, 8))
wedges, texts = ax.pie(
    chart_data,
    labels=labels,
    startangle=140,
    colors=color_list,
    wedgeprops=dict(edgecolor='white'),
    labeldistance=1.2
)

# === Ensure Labels Are Centered Over Slices ===
for text in texts:
    text.set_horizontalalignment('center')
    text.set_fontsize(9)

# === Add Legend for <3% Labels ===
if legend_labels:
    ax.legend(legend_labels, title="Other (<3%)", loc="center left", bbox_to_anchor=(1.15, 0.5))

# === Final Touches ===
plt.title("LEC Failures")
plt.tight_layout()
plt.show()



import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.cm as cm

# Load the Excel file
file_path = r"C:\Users\Checker.xlsx"  # <-- change this to your file
df = pd.read_excel(file_path, sheet_name='Sheet2', engine='openpyxl')

# === Extract Column L (LEC Name) ===
lec_names = df.iloc[:, 1]
lec_counts = lec_names.value_counts()

# === Group infrequent entries into "Misc." ===
frequent = lec_counts[lec_counts > 15]
misc_count = lec_counts[lec_counts <= 15].sum()
chart_data = frequent.copy()
chart_data["Misc."] = misc_count

# === Move "Misc." to the end ===
if "Misc." in chart_data:
    misc_value = chart_data.pop("Misc.")
    chart_data["Misc."] = misc_value

# === Calculate percentages ===
total = chart_data.sum()
percentages = (chart_data / total) * 100

# === Determine label logic ===
labels = []
legend_labels = []
for label, pct in percentages.items():
    if pct >= 3:
        labels.append(f"{label} ({pct:.1f}%)")  # Label shown on slice
    else:
        labels.append("")  # No label on slice
        legend_labels.append(f"{label} ({pct:.1f}%)")  # Goes in legend

# === Assign Custom Colors (one for each slice) ===
base_colors = [
    '#4E79A7', '#F28E2B', '#E15759', '#76B7B2',
    '#59A14F', '#EDC948', '#B07AA1', '#FF9DA7',
    '#9C755F', '#BAB0AC', '#888888'
]
# Extend if needed
color_list = (base_colors * ((len(chart_data) // len(base_colors)) + 1))[:len(chart_data)]

# === Plot Pie Chart ===
fig, ax = plt.subplots(figsize=(10, 8))
wedges, texts = ax.pie(
    chart_data,
    labels=labels,
    startangle=140,
    colors=color_list,
    wedgeprops=dict(edgecolor='white'),
    labeldistance=1.2
)

# === Ensure Labels Are Centered Over Slices ===
for text in texts:
    text.set_horizontalalignment('center')
    text.set_fontsize(9)

# === Add Legend for <3% Labels ===
if legend_labels:
    ax.legend(legend_labels, title="Other (<3%)", loc="center left", bbox_to_anchor=(1.15, 0.5))

# === Final Touches ===
plt.title("LEC Usage Rate")
plt.tight_layout()
plt.show()


import pandas as pd
import matplotlib.pyplot as plt

# Load Excel
file_path = r"C:\Users\Checker.xlsx"
df = pd.read_excel(file_path, sheet_name='Sheet2', engine='openpyxl')

# === Corrected Column Indexes ===
failures_raw = df.iloc[:, 0].dropna().astype(str).str.strip()  # Now using index 1
usages_raw = df.iloc[:, 1].dropna().astype(str).str.strip()

print(f"Total failure entries: {len(failures_raw)}")
print(f"Total usage entries: {len(usages_raw)}")

# === Count LEC occurrences ===
failures = failures_raw.value_counts()
usages = usages_raw.value_counts()

print("\nTop 5 failures:\n", failures.head())
print("\nTop 5 usages:\n", usages.head())

# === Group infrequent LECs (failures <= 15) into "Misc." ===
frequent_failures = failures[failures > 15]
misc_failures_count = failures[failures <= 15].sum()

print(f"\nFrequent failures: {len(frequent_failures)}")
print(f"Misc failure count: {misc_failures_count}")

# Combine with "Misc."
failure_counts = frequent_failures.copy()
failure_counts["Misc."] = misc_failures_count

# Adjust usage counts to align with Misc. grouping
frequent_lecs = set(frequent_failures.index)
usage_counts = pd.Series(dtype=int)

for lec in usages.index:
    count = usages[lec]
    if lec in frequent_lecs:
        usage_counts[lec] = count
    else:
        usage_counts["Misc."] = usage_counts.get("Misc.", 0) + count

print("\nFailure counts:\n", failure_counts.head())
print("\nUsage counts:\n", usage_counts.head())

# === Calculate failure rates ===
failure_rate = {}
for lec in failure_counts.index:
    fail = failure_counts[lec]
    use = usage_counts.get(lec, 0)
    if use > 0:
        failure_rate[lec] = (fail / use) * 100
    else:
        failure_rate[lec] = 0

# Convert to DataFrame and sort
rate_df = pd.Series(failure_rate).sort_values(ascending=False)

print("\nCalculated failure rates:\n", rate_df)

# === Plot horizontal bar chart ===
if not rate_df.empty:
    plt.figure(figsize=(12, 8))
    rate_df.plot(kind='barh', color='#E15759')
    plt.xlabel("Failure Rate (%)")
    plt.title("LEC Failure Rate (Grouped with 'Misc.')")
    plt.gca().invert_yaxis()
    plt.grid(axis='x', linestyle='--', alpha=0.5)
    plt.tight_layout()
    plt.show()
else:
    print("\n⚠️ No failure rates to plot. Check data alignment or thresholds.")
