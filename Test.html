import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.cm as cm
from scipy.stats import pearsonr

# Load the Excel file
file_path = r"C:\U"  # <-- change this to your file
df = pd.read_excel(file_path, sheet_name='Sheet2', engine='openpyxl')

# === Extract Column L (LEC Name) ===
lec_names = df.iloc[:, 0]  # Assuming LEC Name is in the first column

# === Extract Failures and Usages (Indexes 0 & 1) ===
failures = df.iloc[:, 1]  # Assuming failures are in the second column
usages = df.iloc[:, 2]    # Assuming usages are in the third column

# === Group by LEC Name ===
lec_data = df.groupby(lec_names)[[df.columns[1], df.columns[2]]].sum()

# === Compute Failure Rate ===
lec_data["Failure Rate"] = lec_data.iloc[:, 0] / lec_data.iloc[:, 1]

# === Remove LECs with no usages (to prevent divide by zero) ===
lec_data = lec_data[lec_data.iloc[:, 1] > 0]

# === Compute Correlation ===
correlation, _ = pearsonr(lec_data.iloc[:, 1], lec_data["Failure Rate"])

# === Visualization ===
fig, axes = plt.subplots(1, 2, figsize=(14, 6))

# Pie Chart for LEC Selection
lec_counts = lec_names.value_counts()
top_lecs = lec_counts[lec_counts > 5]
misc_count = lec_counts[lec_counts <= 5].sum()
if misc_count > 0:
    top_lecs["Misc."] = misc_count
axes[0].pie(top_lecs, labels=top_lecs.index, autopct='%1.1f%%', colors=cm.tab10.colors)
axes[0].set_title("LEC Selection Distribution")

# Scatter Plot for Correlation
axes[1].scatter(lec_data.iloc[:, 1], lec_data["Failure Rate"], alpha=0.7)
axes[1].set_xlabel("Number of Usages")
axes[1].set_ylabel("Failure Rate")
axes[1].set_title(f"Correlation: {correlation:.2f}")

plt.tight_layout()
plt.show()
