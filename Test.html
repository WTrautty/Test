import openpyxl
import numpy as np
import warnings
import os
from datetime import datetime
import re
import traceback

# ---------------- Configuration ----------------

EXCEL_FILE = r"C:\Users\AD39644\OneDrive - Lumen\Department_of_the_Interior_-_General_Asset_Inventory_Oct2023 (1) (1) (1) Query.xlsx"
LASER_FILE = r"C:\Users\AD39644\Downloads\LASER Export 2-27.xlsx"

# ---------------- Region Mapping Helpers ----------------

def identify_region(wan_ipv6):
    try:
        return wan_ipv6.split(":")[2][1]
    except IndexError:
        return None

def lan_subnet_fix(lan_ipv6):
    try:
        address, subnet = lan_ipv6.split("/")
        hex_groups = address.split(":")
        if len(hex_groups[3]) == 3:
            hex_groups[3] = "0" + hex_groups[3]
        return ":".join(hex_groups) + "/56"
    except Exception:
        return None

def ce_wan_address(ce_wan_ipv6):
    try:
        address, subnet = ce_wan_ipv6.split("/")
        hex_groups = address.split(":")
        hex_groups[-1] = format(int(hex_groups[-1], 16) + 1, "x")
        return ":".join(hex_groups) + f"/{subnet}"
    except Exception:
        return None

def j_barton(lan_ipv6):
    try:
        address = lan_ipv6.split("/")[0]
        return address + "[0-3]"
    except Exception:
        return None

def ipv6_region_map(ipv6_region):
    return {
        "1": "East", "2": "North", "3": "Central", "4": "West", "5": "Alaska"
    }.get(ipv6_region, "unknown")

def md_pw_map(ipv6_region):
    return {
        "1": "5CB60CDAE77980D14277994BB",
        "2": "17A75FE44D8F532715E369E86",
        "3": "A78BA5E3FFFB4F9FE4DDEFC2D",
        "4": "38CE4A74D0004E037471A27B9",
        "5": "D4196D7DF1087CA41E8B5CF72"
    }.get(ipv6_region, "unknown")

def juniper_RI_map(ipv6_region):
    return {
        "1": "8192-1-EIS0176-2006932628-L3VPN",
        "2": "8193-1-EIS0176-2006932629-L3VPN",
        "3": "8194-1-EIS0176-2006932623-L3VPN",
        "4": "8195-1-EIS0176-2006932630-L3VPN",
        "5": "UNKNOWN"
    }.get(ipv6_region, "unknown")

def Nokia_vprn_map(ipv6_region):
    return {
        "1": "22826008",
        "2": "22826009",
        "3": "22826010",
        "4": "22826011",
        "5": "UNKNOWN"
    }.get(ipv6_region, "unknown")

# ---------------- Laser & Excel Logic ----------------

def find_header_row(sheet):
    data = np.array([row for row in sheet.iter_rows(min_row=1, max_row=20, values_only=True)], dtype=object)
    for row_idx, row in enumerate(data, start=1):
        if np.count_nonzero(row) > 2:
            return list(row), row_idx
    return None, None

def search_laser_matches(service_id, ipv6_region, wb_laser):
    sheet = wb_laser["Sheet1"]
    header_row, header_row_idx = find_header_row(sheet)
    headers = {str(cell).replace('\n', ' '): idx for idx, cell in enumerate(header_row) if cell}
    matches = []
    for row in sheet.iter_rows(min_row=header_row_idx + 1, values_only=True):
        for col in headers:
            if "circuitid" in col.lower() and service_id.lower() in str(row[headers[col]]).lower():
                data = {k: row[i] for k, i in headers.items()}
                matches.append({"Data": data})
    return matches

def get_default_interface(laser_matches, ipv6_region):
    target_suffix = f"80{ipv6_region}"
    for lm in laser_matches:
        interface_val = str(lm["Data"].get("interface", "")).strip()
        if interface_val.lower().endswith(target_suffix.lower()):
            return (
                interface_val,
                str(lm["Data"].get("device", "")).strip(),
                str(lm["Data"].get("scid", "")).strip(),
                str(lm["Data"].get("location", "")).strip(),
                str(lm["Data"].get("ipv4", "")).strip(),
                str(lm["Data"].get("vrf", "")).strip()
            )
    return ("", "", "", "", "", "")

# ---------------- Main ----------------

try:
    order_input = input("Enter Ops Console Ticket #: ").strip()
    wb_main = openpyxl.load_workbook(EXCEL_FILE, read_only=True)
    ws = wb_main["Main"]
    header_row, header_row_idx = find_header_row(ws)
    headers = {str(cell).replace('\n', ' '): idx for idx, cell in enumerate(header_row) if cell}

    order_data = None
    for row in ws.iter_rows(min_row=header_row_idx + 1, values_only=True):
        if str(row[headers["Ops Console Ticket"]]).strip() == order_input:
            order_data = {k: row[i] for k, i in headers.items()}
            break
    wb_main.close()

    if not order_data:
        print("Order not found.")
        exit()

    wb_laser = openpyxl.load_workbook(LASER_FILE, read_only=True)
    service_id = str(order_data.get("Service ID", "")).strip()
    ipv6_region = identify_region(order_data.get("IPv6 WAN", ""))
    laser_matches = search_laser_matches(service_id, ipv6_region, wb_laser)
    default_interface,    default_interface, default_scid, default_location, default_wan_ip, default_vrf = get_default_interface(laser_matches, ipv6_region)

    fixed_lan = lan_subnet_fix(order_data.get("IPv6 LAN", ""))
    ce_wan = ce_wan_address(order_data.get("IPv6 WAN", ""))
    area = ipv6_region_map(ipv6_region)
    md_pw = md_pw_map(ipv6_region)
    jRI = juniper_RI_map(ipv6_region)
    vprn = Nokia_vprn_map(ipv6_region)
    j_bar = j_barton(order_data.get("IPv6 LAN", ""))
    device_vendor = order_data.get("Vendor", "").strip()

    # Choose template based on default_device and vendor
    if default_device.upper().startswith("ESP"):
        pe_type = "Alcatel"
        template_path = r"C:\Users\AD39644\Service Information ESP FORT.txt" if device_vendor.upper().startswith("FORT") else r"C:\Users\AD39644\Service Information ESP.txt"
    else:
        pe_type = "Juniper"
        if default_interface.upper().startswith("LSQ"):
            template_path = r"C:\Users\AD39644\Service Information Juno LSQ FORT.txt" if device_vendor.upper().startswith("FORT") else r"C:\Users\AD39644\Service Information Juno LSQ.txt"
        else:
            template_path = r"C:\Users\AD39644\Service Information Juno T1 FORT.txt" if device_vendor.upper().startswith("FORT") else r"C:\Users\AD39644\Service Information Juno T1.txt"

    # Read and fill in template
    with open(template_path, 'r', encoding='utf-8') as file:
        template = file.read()

    template = template.replace('{Ops Console Ticket}', order_input)
    template = template.replace('{iSE Design Link}', order_data.get("iSE Design Link", "").strip() or "Not in Inventory")
    template = template.replace('{Region}', ipv6_region or "")
    template = template.replace('{Lan (Data 1)}', fixed_lan or "")
    template = template.replace('{WAN/126 CE}', ce_wan or "")
    template = template.replace('{WAN/126 CEnoSub}', ce_wan.split('/')[0] if ce_wan else "")
    template = template.replace('{md_pw}', md_pw.strip())
    template = template.replace('{j_bar}', j_bar or "")
    template = template.replace('{jRI}', jRI.strip())
    template = template.replace('{jRI_conf}', jRI.split('-200')[0].strip())
    template = template.replace('{vprn}', vprn.strip())
    template = template.replace('{area}', area.strip())
    template = template.replace('{IPv6_wan_noSub}', order_data.get("IPv6 WAN", "").split('/')[0].strip())
    template = template.replace('{IPv6_lan_noSub}', order_data.get("IPv6 LAN", "").split('/')[0].strip())
    template = template.replace('{IPv6_lan_noSuband1}', order_data.get("IPv6 LAN", "").split('/')[0].strip() + "1")
    template = template.replace('{IPv6_lan_Sub64and1}', order_data.get("IPv6 LAN", "").split('/')[0].strip() + "1/64")
    template = template.replace('{IPv6_lan_and1}', order_data.get("IPv6 LAN", "").split('/')[0].strip() + "1")
    template = template.replace('{WAN_CE}', order_data.get("IPv6 WAN", "").split('/')[0].strip())
    template = template.replace('{Node_Only}', order_data.get("Node Name", "").split('.')[0].strip().upper())
    template = template.replace('{regional_vlan}', "80" + (ipv6_region or "").strip())
    template = template.replace('{IPv6 Status}', order_data.get("IPv6 Status", "").strip())
    if order_data.get("IPv6 Loopback", ""):
        parts = order_data["IPv6 Loopback"].split('/')
        if len(parts) == 2:
            template = template.replace('{IPv6 Loopback_andone}', parts[0] + "/" + parts[1])
    template = template.replace('{Service ID}', service_id)
    template = template.replace('{IPv6 WAN}', order_data.get("IPv6 WAN", "").strip())
    template = template.replace('{IPv6 LAN}', order_data.get("IPv6 LAN", "").strip())
    template = template.replace('{IPv6 Loopback}', order_data.get("IPv6 Loopback", "").strip())
    template = template.replace('{DOI_Bureau}', order_data.get("DOI_Bureau", "").strip())
    template = template.replace('{WHD_Location}', order_data.get("WHD_Location", "").strip())
    template = template.replace('{Node Name}', order_data.get("Node Name", "").strip())
    template = template.replace('{IP Address}', order_data.get("IP Address", "").strip())
    template = template.replace('{Address}', order_data.get("Address", "").strip())
    template = template.replace('{City}', order_data.get("City", "").strip())
    template = template.replace('{State}', order_data.get("State", "").strip())
    template = template.replace('{Vendor}', order_data.get("Vendor", "").strip())
    template = template.replace('{pe_type}', pe_type.strip())
    template = template.replace(
        '{WHD_Location_City}',
        (lambda m: (m.group(1).replace('_', ' ') if m else "").strip())(
            re.search(r'-(?P<group>[^-]*)-(?!.*-)', order_data.get("WHD_Location", " "))
        )
    )

    # Replace LASER values
    template = template.replace('{default_interface}', default_interface.strip())
    template = template.replace('{default_device}', default_device.strip())
    template = template.replace('{default_scid}', default_scid.strip())
    template = template.replace('{default_location}', default_location.strip())
    template = template.replace('{default_wan_ip}', default_wan_ip.strip())
    if default_wan_ip:
        parts = default_wan_ip.split('/')[0].split('.')
        parts[-1] = str(int(parts[-1]) + 1)
        template = template.replace('{default_wan_ipand1}', '.'.join(parts).strip())
    else:
        template = template.replace('{default_wan_ipand1}', "")
    template = template.replace('{default_vrf}', default_vrf.strip())
    template = template.replace('{def_int_noSub}', default_interface.split('.')[0].strip() if default_interface else "")
    template = template.replace('{lsq_int}', default_interface.split('.')[0].replace(':', '.').strip() if default_interface else "")

    # Append all matched laser data
    if laser_matches:
        template += "\n\nNetwork Matches:\n\n"
        for lm in laser_matches:
            for k, v in lm["Data"].items():
                template += f"{k}: {v}\n"
            template += "\n-----------------\n"

    # Save output
    current_date = datetime.now().strftime("%Y-%m-%d")
    output_dir = os.path.join(r"C:\Users\AD39644\IPv6_Test_Files", current_date)
    os.makedirs(output_dir, exist_ok=True)
    filename = f"{order_input.replace('/', '_')} - {current_date} - Pre-Checks.txt"
    output_path = os.path.join(output_dir, filename)

    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(template)

    print(f"Text file created successfully: {output_path}")

except Exception as e:
    print(f"Error: {str(e)}")
    traceback.print_exc()

