import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.cm as cm

# === Step 1: Load Excel data ===
file_path = "C:/Users/AD39644/Desktop/EIS/OneDrive_2024-07-25/Auditing Script/your_file.xlsx"
df = pd.read_excel(file_path, sheet_name='Sheet2', engine='openpyxl')

# === Step 2: Extract LEC Name column (column L = index 11) ===
lec_names = df.iloc[:, 11]
lec_counts = lec_names.value_counts()

# === Step 3: Group infrequent entries into "Misc." ===
frequent = lec_counts[lec_counts > 5]
misc_count = lec_counts[lec_counts <= 5].sum()
chart_data = frequent.copy()
chart_data["Misc."] = misc_count

# === Step 4: Move "Misc." to the end for custom coloring ===
if "Misc." in chart_data:
    misc_value = chart_data.pop("Misc.")
    chart_data["Misc."] = misc_value

# === Step 5: Calculate percentages and split data ===
total = chart_data.sum()
percentages = (chart_data / total) * 100

visible_labels = percentages[percentages >= 3]
small_labels = percentages[percentages < 3]

visible_data = chart_data[visible_labels.index]
small_data = chart_data[small_labels.index]

# === Step 6: Assign distinct colors, gray for Misc ===
num_colors = len(visible_data)
cmap = cm.get_cmap('tab20', num_colors + 1)  # one extra for Misc
color_list = [cmap(i) for i in range(num_colors - 1)] + ['#888888']  # gray for Misc

# === Step 7: Plot the donut chart ===
fig, ax = plt.subplots(figsize=(10, 8))
wedges, texts = ax.pie(
    visible_data,
    labels=[f"{label} ({percent:.1f}%)" for label, percent in visible_labels.items()],
    startangle=140,
    colors=color_list,
    wedgeprops=dict(width=0.4, edgecolor='white')
)

# Add white circle to make it a donut
centre_circle = plt.Circle((0, 0), 0.70, fc='white')
fig.gca().add_artist(centre_circle)

# === Step 8: Add legend for small (< 3%) entries ===
if not small_data.empty:
    legend_labels = [f"{label} ({(count/total)*100:.1f}%)" for label, count in small_data.items()]
    ax.legend(legend_labels, title="Other (<3%)", loc="center left", bbox_to_anchor=(1.15, 0.5))

# === Step 9: Final formatting ===
plt.title("LEC Name Distribution (Donut Style)")
plt.tight_layout()
plt.show()
