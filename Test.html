# $language = "python"
# $interface = "1.0"

import os

def main():
    # Prompt the user for the full path to the command file.
    command_file = crt.Dialog.Prompt("Enter full path to command file:", "Command File", "", False)
    if not command_file:
        crt.Dialog.MessageBox("No file specified. Exiting.")
        return

    if not os.path.isfile(command_file):
        crt.Dialog.MessageBox("File not found: " + command_file)
        return

    try:
        file_handle = open(command_file, "r")
        content = file_handle.read()
        file_handle.close()
    except Exception as e:
        crt.Dialog.MessageBox("Error reading file: " + str(e))
        return

    # Split the file contents into commands using the delimiter "&new&".
    commands = [cmd.strip() for cmd in content.split("&new&") if cmd.strip()]

    # Prompt the user for the prompt string to wait for and an optional timeout value.
    prompt_str = crt.Dialog.Prompt("Enter the prompt string to wait for:", "Prompt String", ">", False)
    timeout_str = crt.Dialog.Prompt("Enter timeout in seconds (default 10):", "Timeout", "10", False)
    try:
        timeout = int(timeout_str)
    except:
        timeout = 10

    # Iterate over the commands, sending each to the session.
    for cmd in commands:
        # Update the status bar with the command being executed.
        crt.Session.SetStatusText("Executing command: " + cmd)
        # Send the command followed by a carriage return.
        crt.Screen.Send(cmd + "\r")
        # Wait for the expected prompt to appear before sending the next command.
        result = crt.Screen.WaitForString(prompt_str, timeout)
        if not result:
            crt.Dialog.MessageBox("Timeout waiting for prompt after command: " + cmd)
            # Optionally, you could break here or continue to the next command.
        else:
            crt.Session.SetStatusText("Prompt detected. Continuing...")

main()
