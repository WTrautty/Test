import re
import os

def mb_to_kbps(mb_str):
    return str(int(mb_str.lower().replace("mb", "")) * 1000)

# === Set your file paths here ===
config_path = "/path/to/your/config.txt"
bandwidths_path = "/path/to/your/bandwidths.txt"
output_path = "/path/to/your/updated_config.txt"

# === Validate paths ===
if not os.path.exists(config_path):
    raise FileNotFoundError(f"Config file not found at: {config_path}")
if not os.path.exists(bandwidths_path):
    raise FileNotFoundError(f"Bandwidths file not found at: {bandwidths_path}")

# === Read bandwidths ===
with open(bandwidths_path, "r") as bw_file:
    bandwidths = [mb_to_kbps(line.strip()) for line in bw_file if line.strip()]

# === Read config ===
with open(config_path, "r") as config_file:
    config_lines = config_file.readlines()

# === Split config into chunks ===
chunks = []
current_chunk = []
for line in config_lines:
    if "vprn" in line:
        if current_chunk:
            chunks.append(current_chunk)
            current_chunk = []
    current_chunk.append(line)
if current_chunk:
    chunks.append(current_chunk)

# === Replace rate/cir values ===
updated_chunks = []
for i, chunk in enumerate(chunks):
    if i >= len(bandwidths):
        print(f"⚠️ Not enough bandwidth entries for all chunks. Skipping chunk {i}.")
        break
    bw_kbps = bandwidths[i]
    new_chunk = []
    for line in chunk:
        line = re.sub(r"(rate\s+)\d+", r"\1" + bw_kbps, line)
        line = re.sub(r"(cir\s+)\d+", r"\1" + bw_kbps, line)
        new_chunk.append(line)
    updated_chunks.append(new_chunk)

# === Write to output file ===
with open(output_path, "w") as out_file:
    for chunk in updated_chunks:
        out_file.writelines(chunk)

print(f"✅ Configuration updated and written to: {output_path}")
