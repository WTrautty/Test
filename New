# PIE CHART: Owner
pie_fig = px.pie(owner_data, names='Closure Code 1', title=f"{owner}'s Closure Code Distribution")
pie_fig.update_traces(textinfo='percent+label')
pie_fig.update_layout(
    autosize=True,
    margin=dict(t=60, l=20, r=20, b=20),
    height=400
)

# PIE CHART: Global average closure codes
global_pie_data = df.groupby('Closure Code 1').size().reset_index(name='Count')
global_pie_fig = px.pie(global_pie_data, names='Closure Code 1', values='Count', title="Global Closure Code Distribution")
global_pie_fig.update_traces(textinfo='percent+label')
global_pie_fig.update_layout(
    autosize=True,
    margin=dict(t=60, l=20, r=20, b=20),
    height=400
)

# LINE CHART
owner_monthly = owner_data.groupby('Month').size().reset_index(name='Completed')
line_fig = go.Figure()
line_fig.add_trace(go.Scatter(
    x=owner_monthly['Month'],
    y=owner_monthly['Completed'],
    mode='lines+markers',
    name=f'{owner} Monthly Completed',
    line=dict(color='blue')
))
line_fig.add_trace(go.Scatter(
    x=global_avg['Month'],
    y=global_avg['Average'],
    mode='lines+markers',
    name='Global Monthly Average',
    line=dict(color='red', dash='dash')
))
line_fig.update_layout(
    title=f"{owner} â€“ Monthly Completed Tasks vs Global Avg",
    xaxis_title='Month',
    yaxis_title='Tasks Completed',
    height=500,
    autosize=True,
    margin=dict(t=60, l=40, r=40, b=40),
    hovermode='x unified'
)

# Convert charts to HTML
pie_html = pie_fig.to_html(full_html=False, include_plotlyjs=(i == 0), config={'responsive': True})
global_pie_html = global_pie_fig.to_html(full_html=False, include_plotlyjs=False, config={'responsive': True})
line_html = line_fig.to_html(full_html=False, include_plotlyjs=False, config={'responsive': True})

# Combine into tab content
tab_buttons.append(f'<button class="tablink" onclick="openTab(event, \'{div_id}\')">{owner}</button>')
tab_contents.append(f'''
<div id="{div_id}" class="tabcontent" style="display:{'block' if i == 0 else 'none'}">
    <h2>{owner}'s Task Breakdown</h2>
    {pie_html}
    <hr>
    <h2>Global Task Closure Code Breakdown</h2>
    {global_pie_html}
    <hr>
    {line_html}
</div>
''')
