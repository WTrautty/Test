# $language = "Python"
# $interface = "1.0"

import sys
import os

def read_current_prompt():
    """
    Reads and returns the current prompt text from the screen.
    """
    return crt.Screen.Get(
        crt.Screen.CurrentRow,
        0,
        crt.Screen.CurrentRow,
        crt.Screen.CurrentColumn
    ).strip()

def wait_for_prompt(expected, timeout=30):
    """
    Waits for a specific string in the current prompt.
    Returns True if the expected string is found within the timeout, otherwise False.
    """
    expected = expected.lower()
    for _ in range(timeout):
        current = read_current_prompt().lower()
        if expected in current:
            return True
        crt.Sleep(1000)
    return False

def send_with_paging(cmd, enter_count=5, delay=500):
    """
    Sends a command and then spams ENTER a few times
    to clear any --More-- paging output.
    """
    crt.Screen.Send(cmd + "\n")
    crt.Sleep(1500)

    for _ in range(enter_count):
        crt.Screen.Send("\n")
        crt.Sleep(delay)

def run_sdwan_checks():
    """
    Runs the requested SD-WAN / inventory commands on the current console session.
    """
    crt.Screen.Synchronous = True

    # Wake up the prompt
    crt.Screen.Send("\n")
    wait_for_prompt("#", timeout=5)

    commands = [
        "show sdwan software",
        "show inv",
        "show sdwan running-config | i Engine",
        "show sdwan running-config | i GigabitEthernet0/1"
    ]

    for cmd in commands:
        send_with_paging(cmd, enter_count=6, delay=400)

        # Final prompt sync after paging clears
        if not wait_for_prompt("#", timeout=60):
            crt.Dialog.MessageBox(
                "Timed out waiting for prompt after command:\n\n{}".format(cmd)
            )
            break

    crt.Dialog.MessageBox("SD-WAN checks complete.")

def main():
    run_sdwan_checks()

main()
