# $language = "Python"
# $interface = "1.0"

import sys
import os
import re

def read_current_prompt():
    return crt.Screen.Get(
        crt.Screen.CurrentRow,
        0,
        crt.Screen.CurrentRow,
        crt.Screen.CurrentColumn
    ).strip()

def wait_for_prompt(expected, timeout=30):
    expected = expected.lower()
    for _ in range(timeout):
        if expected in read_current_prompt().lower():
            return True
        crt.Sleep(1000)
    return False

def send_with_paging(cmd, enter_count=2, delay=400):
    crt.Screen.Send(cmd + "\n")
    crt.Sleep(1500)

    for _ in range(enter_count):
        crt.Screen.Send("\n")
        crt.Sleep(delay)

def check_sdwan_software_version(target_version):
    """
    Checks screen output for:
    - Exact match of target_version
    - Any other 17.x version
    - Or none at all
    """
    try:
        output = crt.Screen.Get(1, 1, crt.Screen.Rows, crt.Screen.Columns)
    except Exception:
        crt.Dialog.MessageBox("Unable to read screen buffer.")
        return

    # Look for exact target version first
    if target_version in output:
        for line in output.splitlines():
            if target_version in line:
                msg = "EXPECTED VERSION FOUND\n\nVersion: {}\n\nLine:\n{}".format(
                    target_version, line.strip()
                )
                crt.Dialog.MessageBox(msg, "SD-WAN Version Check")
                return

    # Look for ANY 17.x version next
    match = re.search(r"(17\.\d+\.\d+\.\d+)", output)
    if match:
        found_version = match.group(1)
        for line in output.splitlines():
            if found_version in line:
                msg = "DIFFERENT 17.x VERSION FOUND\n\nExpected: {}\nFound: {}\n\nLine:\n{}".format(
                    target_version,
                    found_version,
                    line.strip()
                )
                crt.Dialog.MessageBox(msg, "SD-WAN Version Check")
                return

    # If nothing starting with 17. exists at all
    crt.Dialog.MessageBox(
        "NO 17.x SD-WAN VERSION FOUND\n\nCannot locate any software version beginning with 17.",
        "SD-WAN Version Check"
    )

def run_sdwan_checks():
    crt.Screen.Synchronous = True

    # Wake the prompt
    crt.Screen.Send("\n")
    wait_for_prompt("#", timeout=5)

    commands = [
        "show sdwan software",
        "show inv",
        "show sdwan running-config | i Engine",
        "show sdwan running-config | i GigabitEthernet0/1"
    ]

    target_version = "17.12.05.15"

    for cmd in commands:
        send_with_paging(cmd)

        # Wait until prompt comes back
        if not wait_for_prompt("#", timeout=60):
            crt.Dialog.MessageBox(
                "Timed out waiting for prompt after command:\n\n{}".format(cmd)
            )
            break

        # ONLY apply version check to this command
        if cmd == "show sdwan software":
            check_sdwan_software_version(target_version)

    crt.Dialog.MessageBox("SD-WAN CHECKS COMPLETE")

def main():
    run_sdwan_checks()

main()
