import pandas as pd
import re
from collections import Counter

# === Configuration ===
INPUT_FILE = "errors.xlsx"           # Your Excel file
OUTPUT_FILE = "categorized_errors.xlsx"
ERROR_COLUMN = "Error Message"       # Name of the column with error messages
TOP_N_KEYWORDS = 10                  # Number of top words to use as categories
MIN_WORD_LENGTH = 4                  # Ignore very short common words (e.g., "the", "and")

def extract_words(text):
    """
    Extract a list of cleaned lowercase words from text.
    """
    text = str(text).lower()
    words = re.findall(r'\b\w+\b', text)
    return [w for w in words if len(w) >= MIN_WORD_LENGTH]

def main():
    # Load Excel data
    df = pd.read_excel(INPUT_FILE)

    if ERROR_COLUMN not in df.columns:
        raise ValueError(f"Column '{ERROR_COLUMN}' not found.")

    # Count all words across all error messages
    all_words = []
    for msg in df[ERROR_COLUMN]:
        all_words.extend(extract_words(msg))

    word_counts = Counter(all_words)
    top_keywords = [w for w, _ in word_counts.most_common(TOP_N_KEYWORDS)]
    print("Top keywords selected as categories:", top_keywords)

    # Assign category for each row
    def assign_category(msg):
        msg_words = set(extract_words(msg))
        for keyword in top_keywords:
            if keyword in msg_words:
                return keyword.capitalize()
        return "Other"

    df["Category"] = df[ERROR_COLUMN].apply(assign_category)

    # Write to Excel with one sheet per category
    with pd.ExcelWriter(OUTPUT_FILE, engine="openpyxl") as writer:
        for category in sorted(df["Category"].unique()):
            subset = df[df["Category"] == category].drop(columns=["Category"])
            sheet_name = category[:31]
            subset.to_excel(writer, sheet_name=sheet_name, index=False)

    print(f"Categorized file saved to '{OUTPUT_FILE}'.")

if __name__ == "__main__":
    main()
