
df1 = pd.read_excel(EXCEL_PATH, sheet_name=SHEET1_NAME, dtype=str).fillna('').set_index(KEY_COLUMN)
df2 = pd.read_excel(EXCEL_PATH, sheet_name=SHEET2_NAME, dtype=str).fillna('').set_index(KEY_COLUMN)

# === Prepare workbook ===
wb = load_workbook(EXCEL_PATH)

# Remove old output sheets if they exist
for sheet_name in ["Diff_Report", "Added_Rows", "Removed_Rows"]:
    if sheet_name in wb.sheetnames:
        del wb[sheet_name]

diff_ws = wb.create_sheet("Diff_Report")
added_ws = wb.create_sheet("Added_Rows")
removed_ws = wb.create_sheet("Removed_Rows")

highlight_fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")

# === Build Diff_Report (clone of Sheet2 with differences highlighted) ===
diff_ws.append([KEY_COLUMN] + df2.columns.tolist())

for key, row2 in df2.iterrows():
    row_data = [key] + row2.tolist()
    diff_ws.append(row_data)
    row_idx = diff_ws.max_row

    if key in df1.index:
        row1 = df1.loc[key]
        if isinstance(row1, pd.DataFrame):
            row1 = row1.iloc[0]  # Use first if duplicate
        for col_idx, col in enumerate(df2.columns, start=2):  # Start at 2 to skip key column
            if str(row2[col]) != str(row1.get(col, "")):
                diff_ws.cell(row=row_idx, column=col_idx).fill = highlight_fill
    else:
        # Added row — put in Added_Rows sheet
        added_ws.append([key] + row2.tolist())

# === Handle Removed Rows ===
removed_keys = set(df1.index) - set(df2.index)
removed_ws.append([KEY_COLUMN] + df1.columns.tolist())

for key in removed_keys:
    row_or_rows = df1.loc[[key]] if isinstance(df1.loc[key], pd.Series) else df1.loc[key]
    if isinstance(row_or_rows, pd.Series):
        removed_ws.append([key] + row_or_rows.tolist())
    else:
        for _, row in row_or_rows.iterrows():
            removed_ws.append([key] + row.tolist())

# === Save output ===
wb.save("comparison_result.xlsx")
print("✅ Complete. Sheets created: Diff_Report, Added_Rows, Removed_Rows.")
