import pandas as pd
import plotly.express as px

# === Sample Data (replace with your actual Excel path) ===
EXCEL_PATH = r"C:\Path\To\YourMainExcel.xlsx"
EXPORT_HTML = r"C:\Path\To\Output\GlobalDashboard.html"

# === Load and preprocess ===
df = pd.read_excel(EXCEL_PATH, engine='openpyxl')
df = df[['Task Owner', 'Closure Code 1', 'Completed Date']].dropna()
df['Completed Date'] = pd.to_datetime(df['Completed Date'], errors='coerce')
df = df.dropna(subset=['Completed Date'])
df['Month'] = df['Completed Date'].dt.to_period('M').astype(str)
df['Is Fail'] = df['Closure Code 1'].str.lower().str.contains('fail')

# === Global Charts ===

# Global Failure Rate
fail_rate = df.groupby('Month')['Is Fail'].mean().reset_index()
fail_rate['Fail %'] = fail_rate['Is Fail'] * 100
fail_line_fig = px.line(fail_rate, x='Month', y='Fail %', title='Global Failure Rate per Month')
fail_line_fig.update_layout(yaxis=dict(range=[0, 100]), height=400)
fail_line_html = fail_line_fig.to_html(full_html=False, include_plotlyjs=True)

# Global Closure Code Pie
global_pie = df['Closure Code 1'].value_counts(normalize=True) * 100
global_pie_df = global_pie.reset_index()
global_pie_df.columns = ['Closure Code', 'Percentage']
closure_pie_fig = px.pie(global_pie_df, names='Closure Code', values='Percentage',
                         title="Global Closure Code Distribution")
closure_pie_fig.update_layout(height=400)
closure_pie_html = closure_pie_fig.to_html(full_html=False, include_plotlyjs=False)

# Global Closed Orders
closed_monthly = df.groupby('Month').size().reset_index(name='Closed Orders')
closed_line_fig = px.line(closed_monthly, x='Month', y='Closed Orders', title="Global Closed Orders Per Month")
closed_line_fig.update_layout(height=400)
closed_line_html = closed_line_fig.to_html(full_html=False, include_plotlyjs=False)

# === Assemble HTML ===
html_output = f"""
<html>
<head>
    <title>Global Statistics Dashboard</title>
    <style>
        body {{
            font-family: sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }}
        .chart-container {{
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 40px;
        }}
    </style>
</head>
<body>
    <h1 style="text-align:center;">Global Statistics Dashboard</h1>
    
    <div class="chart-container">
        <h2>Failure Rate per Month</h2>
        {fail_line_html}
    </div>

    <div class="chart-container">
        <h2>Closure Code Distribution</h2>
        {closure_pie_html}
    </div>

    <div class="chart-container">
        <h2>Closed Orders per Month</h2>
        {closed_line_html}
    </div>
</body>
</html>
"""

# === Write to file ===
with open(EXPORT_HTML, 'w', encoding='utf-8') as f:
    f.write(html_output)

print(f"âœ… Global dashboard exported to: {EXPORT_HTML}")
