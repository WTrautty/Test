import pandas as pd
import plotly.express as px
import os

# === Configuration ===
EXCEL_PATH = r"C:\Path\To\Your\File.xlsx"  # <- Update this
EXPORT_FOLDER = r"C:\Users\YourName\OneDrive - YourOrg\SharePoint Folder\Dashboards"  # <- Update this
TAB_MIN_ENTRIES = 20

# === Load Excel Data ===
df = pd.read_excel(EXCEL_PATH, engine='openpyxl')
df = df[['Task Owner', 'Closure Code 1']].dropna()

# Filter Task Owners with 20+ entries
owner_counts = df['Task Owner'].value_counts()
valid_owners = owner_counts[owner_counts >= TAB_MIN_ENTRIES].index.tolist()

# Make sure export folder exists
os.makedirs(EXPORT_FOLDER, exist_ok=True)

# === Generate and Save Pie Charts ===
for owner in valid_owners:
    owner_data = df[df['Task Owner'] == owner]
    fig = px.pie(
        owner_data,
        names='Closure Code 1',
        title=f"{owner}'s Closure Code Distribution"
    )
    fig.update_traces(textinfo='percent+label')
    
    safe_owner_name = owner.replace(" ", "_").replace("/", "_")  # Clean filename
    file_path = os.path.join(EXPORT_FOLDER, f"{safe_owner_name}_dashboard.html")
    fig.write_html(file_path)

    print(f"Saved: {file_path}")
