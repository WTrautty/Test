# $language = "Python"
# $interface = "1.0"

import sys
import os

def read_current_prompt():
    """
    Reads and returns the current prompt text from the screen.
    """
    return crt.Screen.Get(
        crt.Screen.CurrentRow,
        0,
        crt.Screen.CurrentRow,
        crt.Screen.CurrentColumn
    ).strip()

def wait_for_prompt(expected, timeout=30):
    """
    Waits for a specific string in the current prompt.
    Returns True if the expected string is found within the timeout, otherwise False.
    """
    expected = expected.lower()
    for _ in range(timeout):
        current = read_current_prompt().lower()
        if expected in current:
            return True
        crt.Sleep(1000)
    return False

def send_with_paging(cmd, enter_count=5, delay=500):
    """
    Sends a command and then sends ENTER a few times
    to clear any --More-- style paging output.
    """
    crt.Screen.Send(cmd + "\n")
    crt.Sleep(1500)

    for _ in range(enter_count):
        crt.Screen.Send("\n")
        crt.Sleep(delay)

def check_sdwan_software_version(target_version):
    """
    Looks for the target_version in the visible screen buffer.
    If found, pops up a message box with the version and full line.
    """
    try:
        # Grab the entire visible screen
        output = crt.Screen.Get(1, 1, crt.Screen.Rows, crt.Screen.Columns)
    except Exception:
        return

    if target_version in output:
        lines = output.splitlines()
        for line in lines:
            if target_version in line:
                msg = "Found version {0} in line:\n\n{1}".format(
                    target_version, line.strip()
                )
                crt.Dialog.MessageBox(msg, "Software Version Found")
                break

def run_sdwan_checks():
    """
    Runs the requested SD-WAN / inventory commands on the current console session.
    """
    crt.Screen.Synchronous = True

    # Wake up the prompt
    crt.Screen.Send("\n")
    wait_for_prompt("#", timeout=5)

    commands = [
        "show sdwan software",
        "show inv",
        "show sdwan running-config | i Engine",
        "show sdwan running-config | i GigabitEthernet0/1"
    ]

    target_version = "17.12.05.15"

    for cmd in commands:
        send_with_paging(cmd, enter_count=6, delay=400)

        # Wait for prompt to come back after command + paging
        if not wait_for_prompt("#", timeout=60):
            crt.Dialog.MessageBox(
                "Timed out waiting for prompt after command:\n\n{0}".format(cmd)
            )
            break

        # Special handling for the show sdwan software command
        if cmd.startswith("show sdwan software"):
            check_sdwan_software_version(target_version)

    crt.Dialog.MessageBox("SD-WAN checks complete.")

def main():
    run_sdwan_checks()

main()
