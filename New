# $language = "Python"
# $interface = "1.0"

import sys
import os
import re

def read_current_prompt():
    return crt.Screen.Get(
        crt.Screen.CurrentRow,
        0,
        crt.Screen.CurrentRow,
        crt.Screen.CurrentColumn
    ).strip()

def wait_for_prompt(expected, timeout=30):
    expected = expected.lower()
    for _ in range(timeout):
        if expected in read_current_prompt().lower():
            return True
        crt.Sleep(1000)
    return False

def send_with_paging(cmd, enter_count=2, delay=400):
    crt.Screen.Send(cmd + "\n")
    crt.Sleep(1500)

    for _ in range(enter_count):
        crt.Screen.Send("\n")
        crt.Sleep(delay)

def clear_screen_with_enters(count=2):
    for _ in range(count):
        crt.Screen.Send("\n")
        crt.Sleep(300)

def get_last_150_lines():
    rows = crt.Screen.Rows
    start = max(1, rows - 150)
    return crt.Screen.Get(start, 1, rows, crt.Screen.Columns)

def check_sdwan_software_version_from_tail(target_version):
    output = get_last_150_lines()

    # Exact expected version
    if target_version in output:
        for line in output.splitlines():
            if target_version in line:
                crt.Dialog.MessageBox(
                    "EXPECTED VERSION FOUND\n\nVersion: {}\n\nLine:\n{}".format(
                        target_version, line.strip()
                    ),
                    "SD-WAN Version Check"
                )
                return

    # Any other 17.x version
    match = re.search(r"(17\.\d+\.\d+\.\d+)", output)
    if match:
        found_version = match.group(1)
        for line in output.splitlines():
            if found_version in line:
                crt.Dialog.MessageBox(
                    "DIFFERENT 17.x VERSION FOUND\n\nExpected: {}\nFound: {}\n\nLine:\n{}".format(
                        target_version,
                        found_version,
                        line.strip()
                    ),
                    "SD-WAN Version Check"
                )
                return

    # No 17.x version at all
    crt.Dialog.MessageBox(
        "NO 17.x SD-WAN VERSION FOUND\n\nCould not locate any software version beginning with 17.",
        "SD-WAN Version Check"
    )

def run_sdwan_checks():
    crt.Screen.Synchronous = True

    # Clear buffer at start
    clear_screen_with_enters(2)

    wait_for_prompt("#", timeout=5)

    commands = [
        "show sdwan software",
        "show inv",
        "show sdwan running-config | i Engine",
        "show sdwan running-config | i GigabitEthernet0/1"
    ]

    target_version = "17.12.05.15"

    # Run all commands first
    for cmd in commands:
        send_with_paging(cmd)

        if not wait_for_prompt("#", timeout=60):
            crt.Dialog.MessageBox(
                "Timed out waiting for prompt after command:\n\n{}".format(cmd)
            )
            break

    # Version check only at the end
    check_sdwan_software_version_from_tail(target_version)

    crt.Dialog.MessageBox("SD-WAN CHECKS COMPLETE")

def main():
    run_sdwan_checks()

main()
