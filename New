<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audit Template Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 15px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .container {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }
    .column {
      flex: 1;
      min-width: 0;
    }
    .field-group {
      margin-bottom: 12px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }
    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 14px;
    }
    textarea {
      min-height: 140px;
      resize: vertical;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      margin-right: 6px;
    }
    .hidden {
      display: none;
    }
    #output,
    #decodedOutput,
    #htmlExport {
      margin-top: 10px;
    }
    #manageSection {
      margin-top: 30px;
      border-top: 1px solid #ccc;
      padding-top: 20px;
    }
    @media (max-width: 800px) {
      .container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <h1>Audit Template Generator</h1>

  <div class="container">
    <!-- LEFT COLUMN: MAIN FORM & OUTPUT -->
    <div class="column">
      <h2>Main Entry</h2>

      <div class="field-group">
        <label for="auditor">Auditor:</label>
        <input type="text" id="auditor">
      </div>

      <!-- Failure Groups / Reasons (multi) -->
      <div class="field-group">
        <label for="failureGroup">Failure Group 1:</label>
        <select id="failureGroup">
          <option value="">-- Select Failure Group --</option>
          <option value="Scrub Failures">Scrub Failures</option>
          <option value="Process">Process</option>
          <option value="Technical">Technical</option>
          <option value="Training">Training</option>
          <option value="Provisioning">Provisioning</option>
        </select>
      </div>

      <div class="field-group">
        <label for="failureReason">Failure Reason 1:</label>
        <select id="failureReason">
          <option value="">-- Select Failure Reason --</option>
          <option value="Missing Documentation">Missing Documentation</option>
          <option value="Incorrect Procedure Followed">Incorrect Procedure Followed</option>
          <option value="System Configuration Error">System Configuration Error</option>
          <option value="Insufficient Training">Insufficient Training</option>
          <option value="Policy Not Followed">Policy Not Followed</option>
          <option value="Data Entry Error">Data Entry Error</option>
        </select>
      </div>

      <div class="field-group" id="fgCountField">
        <label for="fgCount"># of Failure Groups:</label>
        <select id="fgCount">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <!-- Extra Failure Group/Reason pairs -->
      <div id="extraFailureContainer"></div>

      <!-- IC Error and multiple IC error groups -->
      <div class="field-group">
        <label for="icError">IC Error: (Y/N)</label>
        <select id="icError">
          <option value="">-- Select --</option>
          <option value="Y">Y</option>
          <option value="N">N</option>
        </select>
      </div>

      <div class="field-group" id="icCountField">
        <label for="icCount"># of IC Error Groups:</label>
        <select id="icCount">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <!-- Manager/IC pair 1 -->
      <div class="field-group" id="managerField">
        <label for="manager">Manager 1:</label>
        <select id="manager">
          <option value="">-- Select Manager --</option>
          <option value="Manager One">Manager One</option>
          <option value="Manager Two">Manager Two</option>
          <option value="Manager Three">Manager Three</option>
        </select>
      </div>

      <div class="field-group" id="icNameField">
        <label for="icName">IC 1:</label>
        <select id="icName">
          <option value="">-- Select IC --</option>
          <option value="Carlos Ramirez">Carlos Ramirez</option>
          <option value="Dana Nguyen">Dana Nguyen</option>
        </select>
      </div>

      <!-- Extra IC error groups -->
      <div id="extraIcContainer"></div>

      <div class="field-group">
        <label for="failureNotes">Failure Notes:</label>
        <textarea id="failureNotes"></textarea>
      </div>

      <button id="generateBtn">Generate Template</button>
      <button id="copyBtn" type="button">Copy Output</button>

      <h2>Output</h2>
      <textarea id="output" readonly style="height: 270px;"></textarea>
    </div>

    <!-- RIGHT COLUMN: DECODER -->
    <div class="column">
      <h2>Decoder</h2>
      <p>
        You can paste the entire output from the left.<br>
        Only the text after <code>----- RECOVERY CODE -----</code> will be decoded.
      </p>

      <div class="field-group">
        <label for="recoveryInput">Recovery Code or Full Output:</label>
        <textarea id="recoveryInput" placeholder="Paste encoded section or full left-side output here"></textarea>
      </div>

      <button type="button" id="decodeBtn">Decode</button>
      <button type="button" id="copyDecodedBtn">Copy Decoded</button>

      <h3>Decoded Details</h3>
      <textarea id="decodedOutput" readonly></textarea>
    </div>
  </div>

  <!-- BOTTOM SECTION: MANAGE LISTS & HTML EXPORT -->
  <div id="manageSection">
    <h2>Manage Lists</h2>
    <p>Update the available Failure Groups, Failure Reasons, and ICs grouped by Manager. Use one value per line / mapping.</p>

    <div class="field-group">
      <label for="manageFailureGroups">Failure Groups (one per line):</label>
      <textarea id="manageFailureGroups"></textarea>
    </div>

    <div class="field-group">
      <label for="manageFailureReasons">
        Failure Reasons by Group (one per line, format:
        <br><code>Failure Group: Reason One, Reason Two</code>):
      </label>
      <textarea id="manageFailureReasons"></textarea>
    </div>

    <div class="field-group">
      <label for="manageICMapping">ICs by Manager (one manager per line, format: <br>
        <code>Manager Name: IC One, IC Two, IC Three</code>):</label>
      <textarea id="manageICMapping"></textarea>
    </div>

    <button id="applyListsBtn" type="button">Apply Lists</button>
    <button id="refreshHtmlBtn" type="button">Refresh HTML Export</button>
    <button id="copyHtmlBtn" type="button">Copy HTML Export</button>

    <h3>HTML Export</h3>
    <p>This is the full HTML of this page with your current lists baked in. Copy it and paste over the file in your editor to update the shared version.</p>
    <textarea id="htmlExport" readonly></textarea>
  </div>

  <script id="mainScript">
    // ========= CONFIG & CIPHER =========
    const SHIFT = 7;

    // These will be overwritten in HTML Export with your updated lists
    const defaultFailureGroups = [
      "Scrub Failures",
      "Process",
      "Technical",
      "Training",
      "Provisioning"
    ];

    // Flat list (union of all reasons) kept for export/backwards compatibility
    const defaultFailureReasons = [
      "Missing Documentation",
      "Incorrect Procedure Followed",
      "System Configuration Error",
      "Insufficient Training",
      "Policy Not Followed",
      "Data Entry Error"
    ];

    // Per-group mapping (decomposition tree)
    const defaultFailureReasonMap = {
      "Scrub Failures": [
        "Missing Documentation",
        "Data Entry Error"
      ],
      "Process": [
        "Policy Not Followed",
        "Incorrect Procedure Followed"
      ],
      "Technical": [
        "System Configuration Error"
      ],
      "Training": [
        "Insufficient Training"
      ],
      "Provisioning": []
    };

    const defaultIcManagers = {
      "Manager One": [
        "Alex Johnson",
        "Melissa Brown"
      ],
      "Manager Two": [
        "Carlos Ramirez",
        "Dana Nguyen"
      ],
      "Manager Three": [
        "Ethan Patel",
        "Fatima Khan",
        "Greg Thompson",
        "Hannah Lee"
      ]
    };

    // Working copies
    let failureGroups = defaultFailureGroups.slice();
    let failureReasonMap = JSON.parse(JSON.stringify(defaultFailureReasonMap));
    // Flat list derived from map (used only for export / manage text)
    let failureReasons = defaultFailureReasons.slice();
    let icManagers = JSON.parse(JSON.stringify(defaultIcManagers));

    // Cipher helpers
    function encodeText(str, shift) {
      if (shift === undefined) shift = SHIFT;
      let result = "";
      for (let i = 0; i < str.length; i++) {
        const c = str.charCodeAt(i);
        if (c >= 65 && c <= 90) {          // A-Z
          result += String.fromCharCode(((c - 65 + shift) % 26) + 65);
        } else if (c >= 97 && c <= 122) {  // a-z
          result += String.fromCharCode(((c - 97 + shift) % 26) + 97);
        } else if (c >= 48 && c <= 57) {   // 0-9
          result += String.fromCharCode(((c - 48 + shift) % 10) + 48);
        } else {
          result += str[i];
        }
      }
      return result;
    }

    function decodeText(str, shift) {
      if (shift === undefined) shift = SHIFT;
      let result = "";
      for (let i = 0; i < str.length; i++) {
        const c = str.charCodeAt(i);
        if (c >= 65 && c <= 90) {
          result += String.fromCharCode(((c - 65 - shift + 26 * 10) % 26) + 65);
        } else if (c >= 97 && c <= 122) {
          result += String.fromCharCode(((c - 97 - shift + 26 * 10) % 26) + 97);
        } else if (c >= 48 && c <= 57) {
          result += String.fromCharCode(((c - 48 - shift + 10 * 10) % 10) + 48);
        } else {
          result += str[i];
        }
      }
      return result;
    }

    // ========= DOM REFS (set in init) =========
    let failureGroupSelect,
        failureReasonSelect,
        fgCountField,
        fgCountSelect,
        extraFailureContainer,
        icErrorSelect,
        icCountField,
        icCountSelect,
        managerField,
        icNameField,
        managerSelect,
        icNameSelect,
        extraIcContainer,
        outputTextarea,
        recoveryInput,
        decodedOutput,
        manageFailureGroups,
        manageFailureReasons,
        manageICMapping,
        htmlExportTextarea;

    // ========= RENDER HELPERS =========
    function populateFailureGroupSelect(selectEl, selectedVal) {
      selectEl.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "-- Select Failure Group --";
      selectEl.appendChild(placeholder);

      failureGroups.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        selectEl.appendChild(opt);
      });

      if (selectedVal && failureGroups.includes(selectedVal)) {
        selectEl.value = selectedVal;
      } else {
        selectEl.value = "";
      }
    }

    function populateFailureReasonSelect(groupValue, selectEl, selectedVal) {
      selectEl.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = groupValue
        ? "-- Select Failure Reason --"
        : "-- Select Failure Group first --";
      selectEl.appendChild(placeholder);

      const list = groupValue && failureReasonMap[groupValue]
        ? failureReasonMap[groupValue]
        : [];

      list.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        selectEl.appendChild(opt);
      });

      if (selectedVal && list.includes(selectedVal)) {
        selectEl.value = selectedVal;
      } else {
        selectEl.value = "";
      }
    }

    function renderFailureGroups() {
      populateFailureGroupSelect(failureGroupSelect, failureGroupSelect.value);
    }

    function renderFailureReasons() {
      populateFailureReasonSelect(
        failureGroupSelect.value,
        failureReasonSelect,
        failureReasonSelect.value
      );
    }

    function renderManageTextareas() {
      // Failure groups: one per line
      manageFailureGroups.value = failureGroups.join("\n");

      // Failure reasons by group: "Group: r1, r2"
      const frLines = [];
      for (const [grp, reasons] of Object.entries(failureReasonMap)) {
        frLines.push(grp + ": " + (reasons || []).join(", "));
      }
      manageFailureReasons.value = frLines.join("\n");

      // ICs by manager
      const lines = [];
      for (const [mgr, ics] of Object.entries(icManagers)) {
        lines.push(mgr + ": " + ics.join(", "));
      }
      manageICMapping.value = lines.join("\n");
    }

    function populateManagerSelect(selectEl, selectedManager) {
      selectEl.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "-- Select Manager --";
      selectEl.appendChild(placeholder);

      Object.keys(icManagers).forEach(mgr => {
        const opt = document.createElement("option");
        opt.value = mgr;
        opt.textContent = mgr;
        selectEl.appendChild(opt);
      });

      if (selectedManager && Object.keys(icManagers).includes(selectedManager)) {
        selectEl.value = selectedManager;
      } else {
        selectEl.value = "";
      }
    }

    function populateIcSelect(manager, selectEl, selectedIc) {
      selectEl.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = manager ? "-- Select IC --" : "-- Select Manager first --";
      selectEl.appendChild(placeholder);

      const list = manager && icManagers[manager] ? icManagers[manager] : [];
      list.forEach(ic => {
        const opt = document.createElement("option");
        opt.value = ic;
        opt.textContent = ic;
        selectEl.appendChild(opt);
      });

      if (selectedIc && list.includes(selectedIc)) {
        selectEl.value = selectedIc;
      } else {
        selectEl.value = "";
      }
    }

    function renderManagers() {
      const prevManager = managerSelect.value;
      const prevIc = icNameSelect.value;
      populateManagerSelect(managerSelect, prevManager);
      populateIcSelect(managerSelect.value, icNameSelect, prevIc);
    }

    function renderIcNames() {
      const mgr = managerSelect.value;
      const prevIC = icNameSelect.value;
      populateIcSelect(mgr, icNameSelect, prevIC);
    }

    function updateFailureSections() {
      const count = parseInt(fgCountSelect.value || "1", 10) || 1;

      // Capture current selections to preserve them
      const prevGroups = [];
      const prevReasons = [];

      // Pair 1 (base controls)
      prevGroups[0] = failureGroupSelect.value;
      prevReasons[0] = failureReasonSelect.value;

      for (let i = 2; i <= 5; i++) {
        const fgEl = document.getElementById("failureGroup_" + i);
        const frEl = document.getElementById("failureReason_" + i);
        if (fgEl) prevGroups[i - 1] = fgEl.value;
        if (frEl) prevReasons[i - 1] = frEl.value;
      }

      // Re-render base pair
      populateFailureGroupSelect(failureGroupSelect, prevGroups[0] || "");
      populateFailureReasonSelect(
        failureGroupSelect.value,
        failureReasonSelect,
        prevReasons[0] || ""
      );

      // Clear extra pairs
      extraFailureContainer.innerHTML = "";

      if (count <= 1) {
        return;
      }

      // Build extra pairs (2..count)
      for (let i = 2; i <= count; i++) {
        const wrapper = document.createElement("div");
        wrapper.className = "field-group failure-pair";

        const fgLabel = document.createElement("label");
        fgLabel.setAttribute("for", "failureGroup_" + i);
        fgLabel.textContent = "Failure Group " + i + ":";
        wrapper.appendChild(fgLabel);

        const fgSelect = document.createElement("select");
        fgSelect.id = "failureGroup_" + i;
        wrapper.appendChild(fgSelect);

        const frLabel = document.createElement("label");
        frLabel.setAttribute("for", "failureReason_" + i);
        frLabel.textContent = "Failure Reason " + i + ":";
        wrapper.appendChild(frLabel);

        const frSelect = document.createElement("select");
        frSelect.id = "failureReason_" + i;
        wrapper.appendChild(frSelect);

        extraFailureContainer.appendChild(wrapper);

        const prevGroup = prevGroups[i - 1] || "";
        const prevReason = prevReasons[i - 1] || "";

        populateFailureGroupSelect(fgSelect, prevGroup);
        populateFailureReasonSelect(fgSelect.value, frSelect, prevReason);

        fgSelect.addEventListener("change", function () {
          populateFailureReasonSelect(fgSelect.value, frSelect, "");
        });
      }
    }

    function updateIcSections() {
      const icErrorVal = icErrorSelect.value;
      let count = icErrorVal === "Y"
        ? parseInt(icCountSelect.value || "0", 10)
        : 0;

      if (isNaN(count) || count < 0) count = 0;
      if (count > 5) count = 5;

      // Capture current selections to preserve them
      const prevManagers = [];
      const prevIcs = [];

      // Pair 1 (base controls)
      prevManagers[0] = managerSelect.value;
      prevIcs[0] = icNameSelect.value;

      for (let i = 2; i <= 5; i++) {
        const mgrEl = document.getElementById("manager_" + i);
        const icEl = document.getElementById("icName_" + i);
        if (mgrEl) prevManagers[i - 1] = mgrEl.value;
        if (icEl) prevIcs[i - 1] = icEl.value;
      }

      if (icErrorVal === "Y") {
        icCountField.classList.remove("hidden");
        if (count === 0) {
          count = 1;
          icCountSelect.value = "1";
        }
        managerField.classList.remove("hidden");
        icNameField.classList.remove("hidden");
      } else {
        icCountField.classList.add("hidden");
        managerField.classList.add("hidden");
        icNameField.classList.add("hidden");
        icCountSelect.value = "0";
        count = 0;
      }

      // Clear extra pairs
      extraIcContainer.innerHTML = "";

      if (icErrorVal !== "Y" || count === 0) {
        // Just ensure base pair is populated correctly
        renderManagers();
        return;
      }

      // Re-render base pair with preserved values
      populateManagerSelect(managerSelect, prevManagers[0] || "");
      populateIcSelect(managerSelect.value, icNameSelect, prevIcs[0] || "");

      // Build extra IC error groups (2..count)
      for (let i = 2; i <= count; i++) {
        const wrapper = document.createElement("div");
        wrapper.className = "field-group ic-pair";

        const mgrLabel = document.createElement("label");
        mgrLabel.setAttribute("for", "manager_" + i);
        mgrLabel.textContent = "Manager " + i + ":";
        wrapper.appendChild(mgrLabel);

        const mgrSelect = document.createElement("select");
        mgrSelect.id = "manager_" + i;
        wrapper.appendChild(mgrSelect);

        const icLabel = document.createElement("label");
        icLabel.setAttribute("for", "icName_" + i);
        icLabel.textContent = "IC " + i + ":";
        wrapper.appendChild(icLabel);

        const icSelect = document.createElement("select");
        icSelect.id = "icName_" + i;
        wrapper.appendChild(icSelect);

        extraIcContainer.appendChild(wrapper);

        const prevMgr = prevManagers[i - 1] || "";
        const prevIcVal = prevIcs[i - 1] || "";

        populateManagerSelect(mgrSelect, prevMgr);
        populateIcSelect(prevMgr, icSelect, prevIcVal);

        mgrSelect.addEventListener("change", function () {
          populateIcSelect(mgrSelect.value, icSelect, "");
        });
      }
    }

    function renderAll() {
      renderFailureGroups();
      renderFailureReasons();
      updateFailureSections();
      renderManagers();
      updateIcSections();
      renderManageTextareas();
    }

    // ========= HTML EXPORT (FULL PAGE) =========
    function updateHtmlExport() {
      const scriptTag = document.getElementById("mainScript");
      if (!scriptTag || !htmlExportTextarea) return;

      let code = scriptTag.textContent;

      const fgCode = "const defaultFailureGroups = " +
        JSON.stringify(failureGroups, null, 2) + ";";
      const frCode = "const defaultFailureReasons = " +
        JSON.stringify(failureReasons, null, 2) + ";";
      const frmCode = "const defaultFailureReasonMap = " +
        JSON.stringify(failureReasonMap, null, 2) + ";";
      const imCode = "const defaultIcManagers = " +
        JSON.stringify(icManagers, null, 2) + ";";

      code = code.replace(/const defaultFailureGroups =[\s\S]*?;/, fgCode);
      code = code.replace(/const defaultFailureReasons =[\s\S]*?;/, frCode);
      code = code.replace(/const defaultFailureReasonMap =[\s\S]*?;/, frmCode);
      code = code.replace(/const defaultIcManagers =[\s\S]*?;/, imCode);

      scriptTag.textContent = code;

      const fullHtml = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
      htmlExportTextarea.value = fullHtml;
    }

    // ========= PARSE MAPPING TEXTAREA =========
    function parseIcMapping(text) {
      const mapping = {};
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

      lines.forEach(line => {
        const parts = line.split(":");
        if (!parts[0]) return;
        const key = parts[0].trim();
        const rest = parts.slice(1).join(":");
        const list = rest
          .split(",")
          .map(s => s.trim())
          .filter(Boolean);
        if (key && list.length) {
          mapping[key] = list;
        }
      });

      return mapping;
    }

    // ========= INIT & EVENT HOOKUP =========
    function init() {
      // Grab DOM elements
      failureGroupSelect    = document.getElementById("failureGroup");
      failureReasonSelect   = document.getElementById("failureReason");
      fgCountField          = document.getElementById("fgCountField");
      fgCountSelect         = document.getElementById("fgCount");
      extraFailureContainer = document.getElementById("extraFailureContainer");
      icErrorSelect         = document.getElementById("icError");
      icCountField          = document.getElementById("icCountField");
      icCountSelect         = document.getElementById("icCount");
      managerField          = document.getElementById("managerField");
      icNameField           = document.getElementById("icNameField");
      managerSelect         = document.getElementById("manager");
      icNameSelect          = document.getElementById("icName");
      extraIcContainer      = document.getElementById("extraIcContainer");
      outputTextarea        = document.getElementById("output");
      recoveryInput         = document.getElementById("recoveryInput");
      decodedOutput         = document.getElementById("decodedOutput");
      manageFailureGroups   = document.getElementById("manageFailureGroups");
      manageFailureReasons  = document.getElementById("manageFailureReasons");
      manageICMapping       = document.getElementById("manageICMapping");
      htmlExportTextarea    = document.getElementById("htmlExport");

      // Initial render
      renderAll();
      updateHtmlExport();

      // Failure group -> reasons linkage for base pair
      failureGroupSelect.addEventListener("change", function () {
        renderFailureReasons();
      });

      // Change in # of Failure Groups
      fgCountSelect.addEventListener("change", function () {
        updateFailureSections();
      });

      // IC Error toggle (show/hide IC groups)
      icErrorSelect.addEventListener("change", function () {
        updateIcSections();
      });

      // Change in # of IC Error Groups
      icCountSelect.addEventListener("change", function () {
        updateIcSections();
      });

      // Manager -> IC linkage for base pair
      managerSelect.addEventListener("change", function () {
        renderIcNames();
      });

      // Generate + encode
      document.getElementById("generateBtn").addEventListener("click", function () {
        const auditor       = document.getElementById("auditor").value.trim();
        const baseGroup     = failureGroupSelect.value;
        const baseReason    = failureReasonSelect.value;
        let fgCount         = parseInt(fgCountSelect.value || "1", 10) || 1;
        if (fgCount < 1) fgCount = 1;
        if (fgCount > 5) fgCount = 5;

        const icError       = icErrorSelect.value;
        let icCount         = icError === "Y"
          ? parseInt(icCountSelect.value || "0", 10)
          : 0;
        if (isNaN(icCount) || icCount < 0) icCount = 0;
        if (icCount > 5) icCount = 5;

        const failureNotes  = document.getElementById("failureNotes").value.trim();
        const safeNotes     = failureNotes.replace(/\r?\n/g, "\\n");

        // Collect up to 5 Failure Group/Reason pairs
        const groups  = ["", "", "", "", ""];
        const reasons = ["", "", "", "", ""];
        groups[0]  = baseGroup;
        reasons[0] = baseReason;

        for (let i = 2; i <= 5; i++) {
          const fgEl = document.getElementById("failureGroup_" + i);
          const frEl = document.getElementById("failureReason_" + i);
          if (i <= fgCount && fgEl && frEl) {
            groups[i - 1]  = fgEl.value;
            reasons[i - 1] = frEl.value;
          }
        }

        // Collect up to 5 Manager/IC pairs
        const managers = ["", "", "", "", ""];
        const ics      = ["", "", "", "", ""];

        if (icError === "Y" && icCount > 0) {
          managers[0] = managerSelect.value.trim();
          ics[0]      = icNameSelect.value.trim();
        }

        for (let i = 2; i <= 5; i++) {
          const mgrEl = document.getElementById("manager_" + i);
          const icEl  = document.getElementById("icName_" + i);
          if (icError === "Y" && i <= icCount && mgrEl && icEl) {
            managers[i - 1] = mgrEl.value.trim();
            ics[i - 1]      = icEl.value.trim();
          }
        }

        // Build payload:
        // 0: auditor
        // 1: fgCount
        // 2-11: [FG0, FR0, FG1, FR1, ... FG4, FR4] (10 slots)
        // 12: icError
        // 13: icCount
        // 14-23: [Mgr0, IC0, ... Mgr4, IC4] (10 slots)
        // 24: notes
        const parts = [];
        parts.push(auditor);
        parts.push(String(fgCount));
        for (let i = 0; i < 5; i++) {
          parts.push(groups[i] || "", reasons[i] || "");
        }
        parts.push(icError || "");
        parts.push(String(icCount));
        for (let i = 0; i < 5; i++) {
          parts.push(managers[i] || "", ics[i] || "");
        }
        parts.push(safeNotes);

        const recoveryPayload = parts.join("|");
        const encodedLine = encodeText(recoveryPayload);

        const outputText =
          "Auditor: " + auditor + "\n\n" +
          "Failure Notes:\n" + failureNotes + "\n\n" +
          "----- RECOVERY CODE -----\n" +
          encodedLine;

        outputTextarea.value = outputText;
      });

      // Copy output
      document.getElementById("copyBtn").addEventListener("click", function () {
        if (!outputTextarea.value) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(outputTextarea.value).catch(function () {
            outputTextarea.select();
            document.execCommand("copy");
          });
        } else {
          outputTextarea.select();
          document.execCommand("copy");
        }
      });

      // Decode (uses ONLY content after marker)
      document.getElementById("decodeBtn").addEventListener("click", function () {
        const raw = recoveryInput.value;
        if (!raw.trim()) return;

        const marker = "----- RECOVERY CODE -----";
        let encoded = raw;
        const idx = raw.indexOf(marker);
        if (idx !== -1) {
          encoded = raw.substring(idx + marker.length).trim();
        } else {
          encoded = raw.trim();
        }
        if (!encoded) return;

        const decoded = decodeText(encoded);
        const parts = decoded.split("|");

        const failureGroupsDec  = ["", "", "", "", ""];
        const failureReasonsDec = ["", "", "", "", ""];
        const managersDec       = ["", "", "", "", ""];
        const icsDec            = ["", "", "", "", ""];

        let auditorDec       = "";
        let fgCountDec       = 1;
        let icErrorDec       = "";
        let icCountDec       = 0;
        let safeNotesDec     = "";

        // New format: 25+ fields
        if (parts.length >= 25) {
          auditorDec = parts[0] || "";
          fgCountDec = parseInt(parts[1] || "1", 10);
          if (isNaN(fgCountDec) || fgCountDec < 1) fgCountDec = 1;
          if (fgCountDec > 5) fgCountDec = 5;

          let idxBase = 2;
          for (let i = 0; i < 5; i++) {
            failureGroupsDec[i]  = parts[idxBase]     || "";
            failureReasonsDec[i] = parts[idxBase + 1] || "";
            idxBase += 2;
          }

          icErrorDec = parts[12] || "";
          icCountDec = parseInt(parts[13] || "0", 10);
          if (isNaN(icCountDec) || icCountDec < 0) icCountDec = 0;
          if (icCountDec > 5) icCountDec = 5;

          let idxIC = 14;
          for (let i = 0; i < 5; i++) {
            managersDec[i] = parts[idxIC]     || "";
            icsDec[i]      = parts[idxIC + 1] || "";
            idxIC += 2;
          }

          safeNotesDec = parts[24] || "";
        } else {
          // Backward-compatible: older 16-field format
          // [0]auditor,[1]FG1,[2]FR1,[3]icError,[4]manager,[5]ic,
          // [6]fgCount,[7]FG2,[8]FR2,[9]FG3,[10]FR3,[11]FG4,[12]FR4,[13]FG5,[14]FR5,[15]notes
          auditorDec            = parts[0] || "";
          failureGroupsDec[0]   = parts[1] || "";
          failureReasonsDec[0]  = parts[2] || "";
          icErrorDec            = parts[3] || "";
          managersDec[0]        = parts[4] || "";
          icsDec[0]             = parts[5] || "";
          let fgCountRaw        = parts[6] || "1";
          fgCountDec            = parseInt(fgCountRaw, 10);
          if (isNaN(fgCountDec) || fgCountDec < 1) fgCountDec = 1;
          if (fgCountDec > 5) fgCountDec = 5;

          let idxBaseOld = 7;
          for (let i = 1; i < 5; i++) {
            failureGroupsDec[i]  = parts[idxBaseOld]     || "";
            failureReasonsDec[i] = parts[idxBaseOld + 1] || "";
            idxBaseOld += 2;
          }

          safeNotesDec = parts[15] || "";
          icCountDec   = icErrorDec === "Y" ? 1 : 0;
        }

        const failureNotesDec = safeNotesDec.replace(/\\n/g, "\n");

        // Repopulate left form basics
        document.getElementById("auditor").value      = auditorDec;
        document.getElementById("failureNotes").value = failureNotesDec;

        // Failure Groups
        fgCountSelect.value = String(fgCountDec);
        updateFailureSections();

        failureGroupSelect.value = failureGroupsDec[0] || "";
        renderFailureReasons();
        failureReasonSelect.value = failureReasonsDec[0] || "";

        for (let i = 2; i <= fgCountDec; i++) {
          const fgEl = document.getElementById("failureGroup_" + i);
          const frEl = document.getElementById("failureReason_" + i);
          const grpVal = failureGroupsDec[i - 1] || "";
          const reaVal = failureReasonsDec[i - 1] || "";

          if (fgEl) {
            populateFailureGroupSelect(fgEl, grpVal);
          }
          if (frEl) {
            populateFailureReasonSelect(grpVal, frEl, reaVal);
          }
        }

        // IC Error & IC Error Groups
        icErrorSelect.value = icErrorDec;
        icCountSelect.value = String(icCountDec);
        updateIcSections();

        if (icErrorDec === "Y" && icCountDec > 0) {
          const countToApply = icCountDec;

          for (let i = 0; i < countToApply; i++) {
            const mgrName   = managersDec[i] || "";
            const icNameVal = icsDec[i] || "";

            if (mgrName) {
              if (!icManagers[mgrName]) {
                icManagers[mgrName] = [];
              }
            }

            let mgrEl, icEl;
            if (i === 0) {
              mgrEl = managerSelect;
              icEl  = icNameSelect;
            } else {
              mgrEl = document.getElementById("manager_" + (i + 1));
              icEl  = document.getElementById("icName_" + (i + 1));
            }

            if (mgrEl && icEl) {
              populateManagerSelect(mgrEl, mgrName);

              if (mgrName) {
                icManagers[mgrName] = icManagers[mgrName] || [];
                if (icNameVal && !icManagers[mgrName].includes(icNameVal)) {
                  icManagers[mgrName].push(icNameVal);
                }
                populateIcSelect(mgrName, icEl, icNameVal);
              } else {
                populateIcSelect("", icEl, "");
              }
            }
          }
        }

        // Build decoded display
        let decodedText =
          "Auditor: " + auditorDec + "\n" +
          "IC Error: " + (icErrorDec || "N") + "\n";

        if (icErrorDec === "Y" && icCountDec > 0) {
          decodedText += "IC Error Groups:\n";
          for (let i = 0; i < icCountDec && i < 5; i++) {
            if (managersDec[i] || icsDec[i]) {
              decodedText += "  " + (i + 1) + ") " +
                (managersDec[i] || "[no manager]") + " - " +
                (icsDec[i] || "[no IC]") + "\n";
            }
          }
        }

        decodedText += "Failure Groups:\n";
        for (let i = 0; i < fgCountDec && i < 5; i++) {
          if (failureGroupsDec[i] || failureReasonsDec[i]) {
            decodedText += "  " + (i + 1) + ") " +
              (failureGroupsDec[i] || "[no group]") + " - " +
              (failureReasonsDec[i] || "[no reason]") + "\n";
          }
        }

        decodedText += "\nFailure Notes:\n" + failureNotesDec;

        decodedOutput.value = decodedText;
      });

      // Copy decoded
      document.getElementById("copyDecodedBtn").addEventListener("click", function () {
        if (!decodedOutput.value) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(decodedOutput.value).catch(function () {
            decodedOutput.select();
            document.execCommand("copy");
          });
        } else {
          decodedOutput.select();
          document.execCommand("copy");
        }
      });

      // Apply lists
      document.getElementById("applyListsBtn").addEventListener("click", function () {
        const fgLines = manageFailureGroups.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

        // Parse "Failure Group: r1, r2" into a map
        const frMap   = parseIcMapping(manageFailureReasons.value);
        const icMap   = parseIcMapping(manageICMapping.value);

        if (fgLines.length) {
          failureGroups = fgLines;
        }

        if (Object.keys(frMap).length) {
          failureReasonMap = frMap;

          // Derive flat list for export/backwards compatibility
          const allReasons = new Set();
          Object.values(failureReasonMap).forEach(arr => {
            (arr || []).forEach(r => allReasons.add(r));
          });
          failureReasons = Array.from(allReasons);
        }

        if (Object.keys(icMap).length) {
          icManagers = icMap;
        }

        renderAll();
        updateHtmlExport();
      });

      // Refresh HTML export manually
      document.getElementById("refreshHtmlBtn").addEventListener("click", function () {
        updateHtmlExport();
      });

      // Copy HTML export
      document.getElementById("copyHtmlBtn").addEventListener("click", function () {
        if (!htmlExportTextarea.value) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(htmlExportTextarea.value).catch(function () {
            htmlExportTextarea.select();
            document.execCommand("copy");
          });
        } else {
          htmlExportTextarea.select();
          document.execCommand("copy");
        }
      });
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
